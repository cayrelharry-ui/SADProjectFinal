<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="CNSC Extension Services Faculty Dashboard">
    <meta name="theme-color" content="#5A2C9D">
    <title>Faculty Dashboard | CNSC Extension Services</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-5px);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        .slide-in-right {
            animation: slideInRight 0.3s ease-out forwards;
        }

        .slide-in-left {
            animation: slideInLeft 0.3s ease-out forwards;
        }

        .slide-up {
            animation: slideUp 0.4s ease-out forwards;
        }

        .scale-in {
            animation: scaleIn 0.2s ease-out forwards;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .animate-bounce {
            animation: bounce 1s ease-in-out infinite;
        }

        /* Staggered animations */
        .stagger-1 {
            animation-delay: 0.1s;
            opacity: 0;
        }

        .stagger-2 {
            animation-delay: 0.2s;
            opacity: 0;
        }

        .stagger-3 {
            animation-delay: 0.3s;
            opacity: 0;
        }

        .stagger-4 {
            animation-delay: 0.4s;
            opacity: 0;
        }

        /* ===== LOADING SKELETON ===== */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 0px, #f8f8f8 40px, #f0f0f0 80px);
            background-size: 1000px 100%;
            animation: shimmer 2s infinite linear;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 12px;
        }

        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .skeleton-card {
            height: 120px;
        }

        /* ===== STAT CARDS ===== */
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: currentColor;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .stat-card:hover::before {
            opacity: 0.1;
        }

        .stat-card.clickable {
            cursor: pointer;
        }

        /* ===== SIDEBAR ===== */
        .sidebar-item {
            transition: all 0.2s ease;
            position: relative;
        }

        .sidebar-item:hover {
            background: linear-gradient(to right, rgba(90, 44, 157, 0.08), transparent);
        }

        .sidebar-item.active {
            background: linear-gradient(to right, rgba(90, 44, 157, 0.12), transparent);
            color: #5A2C9D;
            font-weight: 600;
        }

        .sidebar-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #5A2C9D;
            border-radius: 0 4px 4px 0;
        }

        .sidebar-item .badge {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover .badge {
            transform: scale(1.1);
        }

        /* ===== MODAL ===== */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .modal-content {
            animation: scaleIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content.closing {
            animation: fadeOut 0.2s ease-out forwards;
        }

        /* ===== TOAST ===== */
        .toast {
            animation: slideInRight 0.3s ease-out;
        }

        .toast.removing {
            animation: slideInRight 0.3s ease-out reverse forwards;
        }

        /* ===== SCROLLBAR ===== */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ===== STATUS BADGES ===== */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-in-progress,
        .status-progress {
            background: #fef3c7;
            color: #92400e;
        }

        .status-completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-pending {
            background: #e0e7ff;
            color: #3730a3;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-revision {
            background: #fef3c7;
            color: #92400e;
        }

        .status-archived {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* ===== CARDS ===== */
        .project-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* ===== TABLE ===== */
        .data-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 10;
        }

        .data-table tbody tr {
            transition: background-color 0.15s ease;
        }

        .data-table tbody tr:hover {
            background-color: #f9fafb;
        }

        /* ===== BUTTONS ===== */
        .btn {
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #5A2C9D;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #4C2684;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(90, 44, 157, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-ghost {
            background: transparent;
            color: #6b7280;
        }

        .btn-ghost:hover:not(:disabled) {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        /* ===== INPUTS ===== */
        .input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: #5A2C9D;
            box-shadow: 0 0 0 3px rgba(90, 44, 157, 0.1);
        }

        .input:disabled {
            background: #f9fafb;
            cursor: not-allowed;
        }

        .input-error {
            border-color: #ef4444;
        }

        .input-error:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }

        /* ===== DROPDOWN ===== */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            min-width: 180px;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(4px);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.625rem 1rem;
            font-size: 0.875rem;
            color: #374151;
            transition: background-color 0.15s ease;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f9fafb;
        }

        .dropdown-item.danger {
            color: #ef4444;
        }

        .dropdown-item.danger:hover {
            background: #fef2f2;
        }

        /* ===== TABS ===== */
        .tab-btn {
            position: relative;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .tab-btn:hover {
            color: #374151;
        }

        .tab-btn.active {
            color: #5A2C9D;
            border-bottom-color: #5A2C9D;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ===== TOOLTIP ===== */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-4px);
            padding: 0.5rem 0.75rem;
            background: #1f2937;
            color: white;
            font-size: 0.75rem;
            border-radius: 0.375rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 100;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            text-align: center;
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        /* ===== AVATAR GROUP ===== */
        .avatar-group {
            display: flex;
            flex-direction: row-reverse;
        }

        .avatar-group .avatar {
            margin-left: -0.5rem;
            border: 2px solid white;
        }

        .avatar-group .avatar:last-child {
            margin-left: 0;
        }

        /* ===== FILE UPLOAD ===== */
        .file-upload-zone {
            border: 2px dashed #e5e7eb;
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .file-upload-zone:hover,
        .file-upload-zone.dragover {
            border-color: #5A2C9D;
            background: rgba(90, 44, 157, 0.02);
        }

        /* ===== TIMELINE ===== */
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.4375rem;
            top: 1.5rem;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            border: 2px solid;
            background: white;
        }

        /* ===== DARK MODE ===== */
        .dark body {
            background: #111827;
            color: #f9fafb;
        }

        .dark .bg-white {
            background: #1f2937;
        }

        .dark .bg-gray-50 {
            background: #111827;
        }

        .dark .text-gray-900 {
            color: #f9fafb;
        }

        .dark .text-gray-700 {
            color: #d1d5db;
        }

        .dark .text-gray-600 {
            color: #9ca3af;
        }

        .dark .text-gray-500 {
            color: #6b7280;
        }

        .dark .border-gray-100 {
            border-color: #374151;
        }

        .dark .border-gray-200 {
            border-color: #374151;
        }

        .dark .skeleton {
            background: linear-gradient(90deg, #374151 0px, #4b5563 40px, #374151 80px);
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .sidebar-collapsed #sidebar {
                transform: translateX(-100%);
            }

            .sidebar-collapsed #main-content {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
            }

            #main-content {
                margin-left: 0;
            }

            .sidebar-open #sidebar {
                transform: translateX(0);
            }

            .sidebar-open .sidebar-overlay {
                display: block;
            }
        }

        .view-container {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== PRINT STYLES ===== */
        @media print {

            #sidebar,
            header,
            .no-print {
                display: none !important;
            }

            #main-content {
                margin-left: 0 !important;
            }

            .project-card {
                break-inside: avoid;
            }
        }

        /* Faculty Proposal Modal Styles */
        .faculty-tab {
            position: relative;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .faculty-tab:hover {
            color: #374151;
        }

        .faculty-tab.active-tab {
            color: #5A2C9D;
            border-bottom-color: #5A2C9D;
            font-weight: 600;
        }

        .faculty-tab-content {
            animation: fadeIn 0.3s ease-out;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'cnsc': {
                            50: '#faf5ff',
                            100: '#f3e8ff',
                            200: '#e9d5ff',
                            300: '#d8b4fe',
                            400: '#c084fc',
                            500: '#5A2C9D',
                            600: '#4C2684',
                            700: '#3d1f6b',
                            800: '#2e1751',
                            900: '#1f0f38'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif']
                    }
                }
            }
        }
    </script>

</head>

<body class="bg-gray-50 antialiased">

    <!-- ========== SIDEBAR OVERLAY (Mobile) ========== -->
    <div id="sidebar-overlay" class="sidebar-overlay hidden fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden"
        onclick="App.toggleSidebar()"></div>

    <!-- ========== SIDEBAR ========== -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-white border-r border-gray-200 z-40 transition-transform duration-300 flex flex-col">
        <!-- Logo -->
        <div class="p-5 border-b border-gray-100 flex-shrink-0">
            <div class="flex items-center space-x-3">

                <!-- Image with size classes (w-10 h-10) directly applied. No background div. -->
                <img src="../logo.png" alt="Logo" class="w-10 h-10 object-cover rounded-xl">

                <div>
                    <h1 class="font-bold text-gray-900 text-xs tracking-tight">CCMS Extension Services</h1>
                    <p class="text-xs text-gray-500">CNSC</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 p-3 space-y-1 overflow-y-auto custom-scrollbar">
            <div class="mb-2">
                <p class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Main Menu</p>
            </div>

            <button data-view="dashboard"
                class="sidebar-item active w-full flex items-center px-3 py-2.5 text-sm rounded-lg text-gray-700"
                aria-label="Dashboard">
                <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                <span>Dashboard</span>
            </button>

            <!-- MODIFIED: This sidebar item now links to Partner Proposals -->
            <button data-view="opportunities"
                class="sidebar-item w-full flex items-center px-3 py-2.5 text-sm text-gray-600 rounded-lg"
                aria-label="Partner Proposals">
                <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                    </path>
                </svg>
                <span>Partner Proposals</span>
                <span id="opp-badge"
                    class="badge ml-auto bg-red-100 text-red-700 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
            </button>

            <button data-view="proposals"
                class="sidebar-item w-full flex items-center px-3 py-2.5 text-sm text-gray-600 rounded-lg"
                aria-label="My Proposals">
                <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <span>My Proposals</span>
                <span id="prop-badge"
                    class="badge ml-auto bg-purple-100 text-purple-700 text-xs font-bold px-2 py-0.5 rounded-full">5</span>
            </button>

            <button data-view="handled"
                class="sidebar-item w-full flex items-center px-3 py-2.5 text-sm text-gray-600 rounded-lg"
                aria-label="Handled Projects">
                <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
                <span>Handled Projects</span>
                <span id="hand-badge"
                    class="badge ml-auto bg-orange-100 text-orange-700 text-xs font-bold px-2 py-0.5 rounded-full">2</span>
            </button>

            <button data-view="completed"
                class="sidebar-item w-full flex items-center px-3 py-2.5 text-sm text-gray-600 rounded-lg"
                aria-label="Completed">
                <svg class="w-5 h-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Completed</span>
                <span id="comp-badge"
                    class="badge ml-auto bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded-full">8</span>
            </button>

            <div class="pt-4 mt-4 border-t border-gray-100">
                <p class="px-3 py-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">Actions</p>
            </div>

            <button onclick="App.openCreateModal()"
                class="w-full bg-gradient-to-r from-cnsc-500 to-cnsc-600 hover:from-cnsc-600 hover:to-cnsc-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 shadow-md shadow-cnsc-500/20 hover:shadow-lg hover:shadow-cnsc-500/30 flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>New Proposal</span>
            </button>
        </nav>

        <!-- User Profile Section -->
        <div class="flex-shrink-0 p-3 border-t border-gray-100 bg-gray-50/50">
            <div class="dropdown" id="profile-dropdown">
                <button onclick="openAccountCard()"
                    class="w-full flex items-center p-2 hover:bg-white rounded-lg transition group">
                    <div class="relative">
                        <img id="user-avatar"
                            src="https://ui-avatars.com/api/?name=Dr.+R.+Magsaysay&background=5A2C9D&color=fff&size=128"
                            class="w-9 h-9 rounded-full border-2 border-white shadow-sm object-cover" alt="Profile">
                        <div
                            class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-400 border-2 border-white rounded-full">
                        </div>
                    </div>
                    <div class="ml-2.5 text-left flex-1 min-w-0">
                        <p id="user-name" class="text-sm font-semibold text-gray-900 truncate">Loading...</p>
                        <p id="user-role" class="text-xs text-gray-500 truncate">Faculty</p>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 group-hover:text-gray-600 transition" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 9l4-4 4 4m0 6l-4 4-4-4"></path>
                    </svg>
                </button>
            </div>
        </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <main id="main-content" class="lg:ml-64 min-h-screen transition-all duration-300">

        <!-- Header -->
        <header class="bg-white border-b border-gray-100 sticky top-0 z-20">
            <div class="px-6 py-4 flex items-center justify-between">
                <!-- Left: Menu Toggle & Title -->
                <div class="flex items-center gap-4">
                    <button id="menu-toggle" onclick="App.toggleSidebar()"
                        class="lg:hidden p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition"
                        aria-label="Toggle menu">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <div>
                        <h1 id="page-title" class="text-xl font-bold text-gray-900">Dashboard</h1>
                        <p id="page-subtitle" class="text-sm text-gray-500 hidden sm:block">Welcome back! Here's what's
                            happening.</p>
                    </div>
                </div>

                <!-- Right: Actions -->
                <div class="flex items-center gap-2 sm:gap-3">
                    <!-- Search (Desktop) -->
                    <div class="relative hidden md:block">
                        <input type="text" id="global-search" placeholder="Search..."
                            class="w-56 lg:w-72 pl-10 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cnsc-500 focus:border-transparent focus:bg-white transition"
                            oninput="App.debounce(() => App.handleSearch(this.value), 300)()">
                        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>

                    <!-- Search (Mobile) -->
                    <button onclick="App.toggleMobileSearch()"
                        class="md:hidden p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition"
                        aria-label="Search">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>

                    <!-- Refresh -->
                    <button onclick="App.refresh()"
                        class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition tooltip"
                        data-tooltip="Refresh" aria-label="Refresh data">
                        <svg id="refresh-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                            </path>
                        </svg>
                    </button>

                    <!-- Notifications -->
                    <div class="dropdown relative" id="notif-dropdown">
                        <button onclick="App.toggleDropdown('notif-dropdown')"
                            class="relative p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg transition"
                            aria-label="Notifications">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                                </path>
                            </svg>
                            <span id="notif-badge"
                                class="absolute -top-0.5 -right-0.5 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                        </button>

                        <!-- Notification Panel -->
                        <div class="dropdown-menu w-80 sm:w-96 max-h-[480px] overflow-hidden flex flex-col">
                            <div
                                class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 flex-shrink-0">
                                <h3 class="font-semibold text-gray-900">Notifications</h3>
                                <button onclick="markAllAsRead()"
                                    class="text-xs text-cnsc-500 hover:text-cnsc-600 font-medium">Mark all read</button>
                            </div>
                            <div id="notif-list" class="flex-1 overflow-y-auto custom-scrollbar">
                                <div class="p-4 text-center text-gray-400 text-xs">Loading...</div>
                            </div>
                            <div class="p-3 border-t border-gray-100 bg-gray-50 flex-shrink-0">
                                <button onclick="App.showView('notifications')"
                                    class="w-full text-center text-sm text-cnsc-500 hover:text-cnsc-600 font-medium">View
                                    all notifications</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Search Bar (Hidden by default) -->
            <div id="mobile-search-bar" class="hidden px-4 pb-4 md:hidden">
                <div class="relative">
                    <input type="text" placeholder="Search projects..."
                        class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cnsc-500 focus:border-transparent transition"
                        oninput="App.debounce(() => App.handleSearch(this.value), 300)()">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="content-area" class="p-4 sm:p-6">

            <!-- ========== DASHBOARD VIEW ========== -->
            <div id="view-dashboard" class="view-container fade-in">
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-5 mb-6">
                    <!-- Opportunities Stat -->
                    <!-- MODIFIED: This card now tracks and links to Partner Proposals -->
                    <div class="stat-card clickable bg-white rounded-xl p-4 sm:p-5 border border-gray-100 shadow-sm cursor-pointer"
                        onclick="App.showView('opportunities')" style="color: #ef4444;">
                        <div class="flex items-center justify-between mb-3">
                            <div
                                class="w-10 h-10 sm:w-11 sm:h-11 bg-red-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-red-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z">
                                    </path>
                                </svg>
                            </div>
                            <span
                                class="text-xs font-medium text-red-600 bg-red-50 px-2 py-1 rounded-full hidden sm:inline">View
                                →</span>
                        </div>
                        <h3 id="stat-opps" class="text-2xl sm:text-3xl font-bold text-gray-900">...</h3>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">New Partner Proposals</p>
                    </div>


                    <!-- My Proposals Stat -->
                    <div class="stat-card clickable bg-white rounded-xl p-4 sm:p-5 border border-gray-100 shadow-sm"
                        onclick="App.showView('proposals')" style="color: #8b5cf6;">
                        <div class="flex items-center justify-between mb-3">
                            <div
                                class="w-10 h-10 sm:w-11 sm:h-11 bg-purple-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-purple-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                            </div>
                            <span
                                class="text-xs font-medium text-purple-600 bg-purple-50 px-2 py-1 rounded-full hidden sm:inline">View
                                →</span>
                        </div>
                        <h3 id="stat-props" class="text-2xl sm:text-3xl font-bold text-gray-900">...</h3>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">My Proposals</p>
                    </div>

                    <!-- Handled Projects Stat -->
                    <div class="stat-card clickable bg-white rounded-xl p-4 sm:p-5 border border-gray-100 shadow-sm"
                        onclick="App.showView('handled')" style="color: #f97316;">
                        <div class="flex items-center justify-between mb-3">
                            <div
                                class="w-10 h-10 sm:w-11 sm:h-11 bg-orange-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-orange-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                    </path>
                                </svg>
                            </div>
                            <span
                                class="text-xs font-medium text-orange-600 bg-orange-50 px-2 py-1 rounded-full hidden sm:inline">View
                                →</span>
                        </div>
                        <h3 id="stat-hand" class="text-2xl sm:text-3xl font-bold text-gray-900">...</h3>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">Handled Projects</p>
                    </div>

                    <!-- Completed Stat -->
                    <div class="stat-card clickable bg-white rounded-xl p-4 sm:p-5 border border-gray-100 shadow-sm"
                        onclick="App.showView('completed')" style="color: #10b981;">
                        <div class="flex items-center justify-between mb-3">
                            <div
                                class="w-10 h-10 sm:w-11 sm:h-11 bg-green-50 rounded-lg flex items-center justify-center">
                                <svg class="w-5 h-5 sm:w-6 sm:h-6 text-green-600" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <span
                                class="text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded-full hidden sm:inline">View
                                →</span>
                        </div>
                        <h3 id="stat-comp" class="text-2xl sm:text-3xl font-bold text-gray-900">...</h3>
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">Completed</p>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <!-- Recent Activity (Left - 2 cols) -->
                    <div class="xl:col-span-2 bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                        <div class="p-5 border-b border-gray-100 flex items-center justify-between">
                            <div>
                                <h2 class="text-lg font-bold text-gray-900">Recent Activity</h2>
                                <p class="text-sm text-gray-500 mt-0.5">Latest updates on your projects</p>
                            </div>
                            <button onclick="App.showView('proposals')"
                                class="text-sm font-medium text-cnsc-500 hover:text-cnsc-600 transition">
                                View All →
                            </button>
                        </div>
                        <div id="recent-activity-list" class="divide-y divide-gray-50">
                            <div class="p-4 text-center text-gray-400">Loading activities...</div>
                        </div>
                    </div>

                    <!-- Right Sidebar (1 col) -->
                    <div class="space-y-6">
                        <!-- Upcoming Deadlines -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-gray-100">
                                <h2 class="text-lg font-bold text-gray-900">Upcoming Deadlines</h2>
                                <p class="text-sm text-gray-500 mt-0.5">Don't miss these dates</p>
                            </div>
                            <div class="p-4 space-y-4">
                                <!-- Deadline Item 1 -->
                                <div class="flex items-start gap-3">
                                    <div
                                        class="w-12 h-12 bg-red-50 rounded-lg flex flex-col items-center justify-center flex-shrink-0 border border-red-100">
                                        <span class="text-xs font-bold text-red-600 uppercase">Dec</span>
                                        <span class="text-lg font-bold text-red-700 leading-none">15</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-semibold text-gray-900 truncate">Environmental Awareness
                                            Campaign</p>
                                        <p class="text-xs text-gray-500 mt-0.5">Proposal submission deadline</p>
                                        <div class="flex items-center gap-1 mt-1.5">
                                            <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                                            <span class="text-xs font-medium text-red-600">3 days left</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                            <div class="p-5 border-b border-gray-100">
                                <h2 class="text-lg font-bold text-gray-900">Quick Actions</h2>
                                <p class="text-sm text-gray-500 mt-0.5">Common tasks</p>
                            </div>
                            <div class="p-4 space-y-2">
                                <button onclick="App.openCreateModal()"
                                    class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition text-left group">
                                    <div
                                        class="w-10 h-10 bg-cnsc-50 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-cnsc-100 transition">
                                        <svg class="w-5 h-5 text-cnsc-600" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900">Create Proposal</p>
                                        <p class="text-xs text-gray-500">Start a new extension project</p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== OTHER VIEWS (Initially Hidden) ========== -->
            <!-- MODIFIED: This view is now for Partner Proposals -->
            <div id="view-opportunities" class="view-container hidden">
                <!-- Header with Title and Search Bar -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Review Partner Proposals</h2>
                        <p class="text-sm text-gray-500">Proposals submitted by external organizations.</p>
                    </div>
                    <div class="relative w-full md:w-64">
                        <input type="text" id="search-input" oninput="debounceSearch()"
                            placeholder="Search proposals..."
                            class="w-full pl-10 pr-4 py-2 bg-white border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-cnsc-500 transition">
                        <svg class="w-4 h-4 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                </div>

                <!-- Table to Display Proposals -->
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th class="px-6 py-4">Subject</th>
                                    <th class="px-6 py-4">Organization</th>
                                    <th class="px-6 py-4">Date Submitted</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="partner-opps-body" class="divide-y divide-gray-200">
                                <!-- This will be filled by the updated JavaScript -->
                                <tr>
                                    <td colspan="5" class="px-6 py-10 text-center text-gray-400">Loading proposals...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-proposals" class="hidden">
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="p-5 border-b border-gray-100 flex justify-between items-center">
                        <div>
                            <h2 class="text-lg font-bold text-gray-900">My Submitted Proposals</h2>
                            <p class="text-sm text-gray-500 mt-0.5">Manage and track your submissions</p>
                        </div>
                        <div class="flex gap-2">
                            <button id="toggle-archives-btn" onclick="toggleArchives()"
                                class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold rounded-lg shadow-sm text-sm transition">Show
                                Archives</button>
                            <a href="SubmitProposal.html"
                                class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-sm text-sm flex items-center gap-2">
                                <span>+</span> Create New
                            </a>
                        </div>
                    </div>
                    <div class="p-4 overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-600 data-table">
                            <thead class="text-xs text-gray-700 uppercase bg-purple-50">
                                <tr>
                                    <th class="px-6 py-4">Proposal Title</th>
                                    <th class="px-6 py-4">Submission Date</th>
                                    <th class="px-6 py-4">Status</th>
                                    <th class="px-6 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="my-proposals-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div id="view-handled" class="hidden">
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="p-5 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900">Projects I Handled</h2>
                        <p class="text-sm text-gray-500 mt-0.5">Visual overview of projects you've claimed</p>
                    </div>
                    <div class="p-5">
                        <div id="handled-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
            </div>
            <div id="view-completed" class="hidden">
                <div class="bg-white rounded-xl border border-gray-100 shadow-sm overflow-hidden">
                    <div class="p-5 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900">Completed Projects</h2>
                        <p class="text-sm text-gray-500 mt-0.5">Archive of finished extension projects</p>
                    </div>
                    <div class="p-5">
                        <div id="completed-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                    </div>
                </div>
            </div>
            <div id="view-profile" class="hidden"></div>
            <div id="view-settings" class="hidden"></div>
            <div id="view-notifications" class="hidden"></div>
        </div>
    </main>

    <script>
        // App scaffold for UI interaction
        const App = {
            debounce(fn, delay) {
                let t; return function (...args) { clearTimeout(t); t = setTimeout(() => fn.apply(this, args), delay); };
            },
            toggleSidebar() {
                const body = document.body;
                const sidebar = document.getElementById('sidebar');
                if (window.innerWidth < 1024) { // Mobile/Tablet
                    body.classList.toggle('sidebar-open');
                } else { // Desktop
                    body.classList.toggle('sidebar-collapsed');
                    document.getElementById('main-content').classList.toggle('lg:ml-64');
                    sidebar.classList.toggle('w-64');
                    sidebar.classList.toggle('w-0');
                }
            },
            toggleMobileSearch() {
                const el = document.getElementById('mobile-search-bar');
                if (el) el.classList.toggle('hidden');
            },
            refresh() {
                const icon = document.getElementById('refresh-icon');
                if (icon) {
                    icon.classList.add('animate-spin');
                    // Add calls to refetch data
                    fetchDashboardData();
                    setTimeout(() => icon.classList.remove('animate-spin'), 800);
                }
            },
            toggleDropdown(id) {
                // Close all other dropdowns first
                document.querySelectorAll('.dropdown').forEach(d => {
                    if (d.id !== id) d.classList.remove('open');
                });
                const dd = document.getElementById(id);
                if (dd) dd.classList.toggle('open');
            },
            showView(view) {
                document.querySelectorAll('[data-view]').forEach(btn => btn.classList.remove('active'));

                // --- FIX START ---
                // The original line was only hiding elements with the '.view-container' class.
                // This new selector targets all direct children of '#content-area', ensuring all views are hidden.
                document.querySelectorAll('#content-area > div').forEach(v => v.classList.add('hidden'));
                // --- FIX END ---

                const el = document.getElementById(`view-${view}`);
                if (el) el.classList.remove('hidden');

                const btn = document.querySelector(`[data-view="${view}"]`);
                if (btn) btn.classList.add('active');

                const titleMap = { dashboard: 'Dashboard', opportunities: 'Opportunities', proposals: 'My Proposals', handled: 'Handled Projects', completed: 'Completed', profile: 'My Profile', settings: 'Settings', notifications: 'Notifications' };
                const pageTitle = document.getElementById('page-title');
                if (pageTitle && titleMap[view]) pageTitle.textContent = titleMap[view];

                // Load data for the activated view
                if (view === 'dashboard') fetchDashboardData();
                if (view === 'opportunities') fetchPartnerOpps();
                if (view === 'proposals') fetchMyProposals();
                if (view === 'handled') fetchHandledProjects();
                if (view === 'completed') fetchCompletedProjects();
            },
            openCreateModal() {
                // In a real app, this would open a form. We can link it to the existing page.
                window.location.href = 'SubmitProposal.html';
            },
            openUploadModal() { alert('Open Upload Modal (placeholder)'); },
            toggleDarkMode() {
                document.documentElement.classList.toggle('dark');
                const isDark = document.documentElement.classList.contains('dark');
                localStorage.setItem('darkMode', isDark);
                const text = document.getElementById('theme-text');
                if (text) text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            },
            handleSearch(q) {
                // This is a global search, could be implemented to search across all tables
                console.log('Searching for:', q);
            },
            logout() {
                if (confirm('Are you sure you want to sign out?')) {
                    alert('Signing out...');
                }
            }
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('open'));
            }
        });

        // Apply dark mode on load
        if (localStorage.getItem('darkMode') === 'true') {
            App.toggleDarkMode();
        }
    </script>


    <!-- FULLY INTEGRATED SCRIPT FROM Faculty.html -->
    <script>
        const supabaseUrl = 'https://fkdqenrxfanpgmtogiig.supabase.co/';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZHFlbnJ4ZmFucGdtdG9naWlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDA1NzksImV4cCI6MjA4MDMxNjU3OX0.NSA57GQcxnCpLnqMVlDpf_lvfggb2H-IGGTBL_XYQ4I';

        let sbClient;
        try {
            sbClient = window.supabase.createClient(supabaseUrl, supabaseKey);
            (function () {
                emailjs.init("qRx5WRPit73IDD8Z4");
            })();
        } catch (e) {
            console.error("Initialization Error:", e);
            alert("Failed to initialize app services. Check console.");
        }

        // --- GLOBAL STATE ---
        let selectedProposalId = null;
        let showArchived = false;
        let searchTimer;
        let activeCategory = 'Partner';
        let currentProjectId = null;
        let currentProfileDbId = null;
        let currentUser = null;
        let currentUserEmail = null;
        let currentFacultyProposalId = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            if (sbClient) {
                fetchUserProfileAndData();
                fetchNotifications();
                setInterval(fetchNotifications, 30000); // Poll for notifications
            }
            // Wire up sidebar buttons to data-loading functions
            document.querySelectorAll('button[data-view]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const view = btn.getAttribute('data-view');
                    App.showView(view); // This handles UI switching
                });
            });
        });

        // --- LOGOUT FUNCTION ---
App.logout = async function() {
    if (!confirm('Are you sure you want to sign out?')) {
        return;
    }
    
    try {
        // Sign out from Supabase
        if (sbClient && sbClient.auth) {
            const { error } = await sbClient.auth.signOut();
            if (error) throw error;
        }
        
        // Clear all local storage
        localStorage.clear();
        sessionStorage.clear();
        
        // Show success message
        alert('Signed out successfully! Redirecting to login...');
        
        // Redirect to login page
        window.location.href = '../HTML/LogIn.html';
        
    } catch (error) {
        console.error('Logout error:', error);
        // Still redirect even if there's an error
        alert('Signing out...');
        window.location.href = '../HTML/LogIn.html';
    }
};

        async function fetchUserProfileAndData() {
            await fetchUserProfile();
            fetchDashboardData();
        }

        async function fetchDashboardData() {
            if (!sbClient || !currentUser) return;

            // Fetch counts for stat cards
            const { count: oppsCount } = await sbClient.from('partner_opportunities').select('*', { count: 'exact' }).eq('status', 'New');
            const { count: propsCount } = await sbClient.from('faculty_extension_proposals').select('*', { count: 'exact' }).neq('status', 'Archived');
            // Corrected query for Handled: should not include 'Completed' status
            const { count: handCount } = await sbClient.from('partner_opportunities').select('*', { count: 'exact' }).eq('claimed_by', currentUser).neq('status', 'Completed');
            const { count: compCount } = await sbClient.from('partner_opportunities').select('*', { count: 'exact' }).eq('status', 'Completed');

            // Update the main dashboard stat cards
            document.getElementById('stat-opps').textContent = oppsCount || 0;
            document.getElementById('stat-props').textContent = propsCount || 0;
            document.getElementById('stat-hand').textContent = handCount || 0;
            document.getElementById('stat-comp').textContent = compCount || 0;

            // NEW: Update the sidebar badges
            document.getElementById('opp-badge').textContent = oppsCount || 0;
            document.getElementById('prop-badge').textContent = propsCount || 0;
            document.getElementById('hand-badge').textContent = handCount || 0;
            document.getElementById('comp-badge').textContent = compCount || 0;

            // Fetch recent activities
            const { data: activity, error } = await sbClient.from('faculty_extension_proposals').select('*').order('created_at', { ascending: false }).limit(5);
            const activityList = document.getElementById('recent-activity-list');
            if (error || !activity.length) {
                activityList.innerHTML = `<div class="p-4 text-center text-gray-500">No recent activity.</div>`;
                return;
            }
            activityList.innerHTML = activity.map(item => {
                let statusClass = 'status-pending';
                if (item.status === 'Approved') statusClass = 'status-approved';
                if (item.status === 'Revision Requested') statusClass = 'status-revision';
                if (item.status === 'Completed') statusClass = 'status-completed';

                return `
                    <div class="p-4 hover:bg-gray-50 transition cursor-pointer" onclick="openFacultyProposalModal('${encodeURIComponent(JSON.stringify(item))}')">
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <span>📄</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center justify-between gap-2">
                                    <p class="text-sm font-semibold text-gray-900 truncate">${item.title}</p>
                                    <span class="status-badge ${statusClass} flex-shrink-0">${item.status}</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 line-clamp-1">${item.rationale ? (item.rationale.length > 100 ? item.rationale.substring(0, 100) + '...' : item.rationale) : 'No description available.'}</p>
                                <p class="text-xs text-gray-400 mt-2">${new Date(item.created_at).toLocaleString()}</p>
                            </div>
                        </div>
                    </div>`;
            }).join('');
        }


        // --- AUTH & PROFILE MANAGEMENT ---
        async function fetchUserProfile() {
            try {
                const { data, error } = await sbClient.from('faculty_profiles').select('*').limit(1).single();
                if (error) throw error;

                if (data) {
                    currentProfileDbId = data.id;
                    currentUser = data.full_name;
                    currentUserEmail = data.email;

                    // Update all UI elements with user data
                    const timestamp = '?t=' + new Date().getTime();
                    const avatarSrc = data.avatar_url ? data.avatar_url + timestamp : `https://ui-avatars.com/api/?name=${encodeURIComponent(data.full_name)}&background=5A2C9D&color=fff`;

                    document.getElementById('user-name').textContent = data.full_name;
                    document.getElementById('user-role').textContent = data.role || 'Faculty';
                    document.getElementById('user-avatar').src = avatarSrc;

                    document.getElementById('account-name').textContent = data.full_name;
                    document.getElementById('account-email').textContent = data.email;
                    document.getElementById('account-avatar').src = avatarSrc;

                    document.getElementById('input-name').value = data.full_name;
                    document.getElementById('input-email').value = data.email;
                    document.getElementById('input-bio').value = data.bio || "";
                    document.getElementById('modal-profile-img').src = avatarSrc;
                }
            } catch (e) {
                console.error("Profile Load Error:", e);
                alert("Could not load user profile. Some features might be affected.");
            }
        }

        async function saveProfileChanges() {
            const newName = document.getElementById('input-name').value;
            const newEmail = document.getElementById('input-email').value;
            const newBio = document.getElementById('input-bio').value;
            const fileInput = document.getElementById('profile-upload');

            const saveBtn = event.target;
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.innerHTML = "Saving...";
            saveBtn.disabled = true;

            try {
                let newAvatarUrl = null;
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    const fileName = `${currentProfileDbId}-${Date.now()}.${file.name.split('.').pop()}`;
                    const { error: uploadError } = await sbClient.storage.from('avatars').upload(fileName, file, { upsert: true });
                    if (uploadError) throw uploadError;
                    const { data: urlData } = sbClient.storage.from('avatars').getPublicUrl(fileName);
                    newAvatarUrl = urlData.publicUrl;
                }

                const updateData = { full_name: newName, email: newEmail, bio: newBio };
                if (newAvatarUrl) updateData.avatar_url = newAvatarUrl;

                const { error: dbError } = await sbClient.from('faculty_profiles').update(updateData).eq('id', currentProfileDbId);
                if (dbError) throw dbError;

                if (newName !== currentUser) {
                    await sbClient.from('partner_opportunities').update({ claimed_by: newName }).eq('claimed_by', currentUser);
                }

                alert("Profile updated successfully!");
                await fetchUserProfileAndData(); // Refresh all user data and dependent views
                closeProfileModal();

            } catch (e) {
                console.error(e);
                alert("Error updating profile: " + e.message);
            } finally {
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
            }
        }

        function previewProfileImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = e => { document.getElementById('modal-profile-img').src = e.target.result; }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- DATA FETCHING & RENDERING (for each view) ---
        function setCategory(category, btn) {
            activeCategory = category;
            document.querySelectorAll('.filter-btn').forEach(b => {
                const inactive = b.dataset.inactiveClass.split(' ');
                const active = b.dataset.activeClass.split(' ');
                b.classList.remove(...active);
                b.classList.add(...inactive);
            });
            const inactive = btn.dataset.inactiveClass.split(' ');
            const active = btn.dataset.activeClass.split(' ');
            btn.classList.remove(...inactive);
            btn.classList.add(...active);
            applyFilters();
        }

        function debounceSearch() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(applyFilters, 300);
        }

        function applyFilters() { fetchPartnerOpps(); }

        // MODIFIED: This function now uses the 'mailto' workflow
        async function fetchPartnerOpps() {
            const tbody = document.getElementById('partner-opps-body');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-400 animate-pulse">Loading partner proposals...</td></tr>`;

            try {
                const { data, error } = await sbClient.from('partners_proposals').select('*').in('status', ['New', 'Under Review']).order('created_at', { ascending: false });
                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-10 text-center text-gray-500">No partner proposals found.</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(sub => {
                    const dateStr = new Date(sub.created_at).toLocaleDateString();
                    const safeData = encodeURIComponent(JSON.stringify(sub));

                    // --- THIS IS THE KEY CHANGE ---
                    // The button now calls 'sendManualEmail'
                    const actionsHtml = `
                <div class="flex items-center justify-end gap-4">
                    <button onclick="openProjectModal('${safeData}')" class="font-bold text-gray-500 hover:underline text-xs uppercase">Details</button>
                    <a href="SubmitProposal.html?data=${safeData}" class="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white font-bold text-xs rounded shadow-md">Draft Proposal</a>
                </div>
            `;

                    return `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-bold text-gray-800">${sub.subject}</td>
                    <td class="px-6 py-4 text-gray-600">${sub.organization_name}</td>
                    <td class="px-6 py-4 text-gray-500">${dateStr}</td>
                    <td class="px-6 py-4"><span class="px-3 py-1 text-xs font-bold rounded-full bg-yellow-100 text-yellow-800">${sub.status}</span></td>
                    <td class="px-6 py-4 text-right">${actionsHtml}</td>
                </tr>
            `;
                }).join('');
            } catch (error) {
                console.error("Partner Proposals Error:", error);
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-8 text-center text-red-500"><strong>Error:</strong> ${error.message}</td></tr>`;
            }
        }

        // MODIFIED FUNCTION: Added console logs for debugging
        function sendManualEmail(encodedData) {
            const proposal = JSON.parse(decodeURIComponent(encodedData));

            // --- DEBUG START ---
            console.log("Attempting to send manual email. Proposal data:", proposal);
            // --- DEBUG END ---

            if (!proposal.contact_email) {
                alert("This proposal does not have a contact email address on file.");
                return;
            }

            const statusUpdate = proposal.status || 'Reviewed';
            const to = proposal.contact_email;
            const subject = `Update on your CNSC Proposal: ${proposal.subject}`;
            const body = `Dear ${proposal.contact_full_name || 'Partner'},\n\n` +
                `Thank you for your proposal, "${proposal.subject}", submitted on behalf of ${proposal.organization_name}.\n\n` +
                `We are writing to inform you that your proposal status has been updated to: ${statusUpdate}.\n\n` +
                `Our team will be in touch if any further action is required from your side.\n\n` +
                `Sincerely,\n` +
                `The CNSC Extension Services Team`;

            const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

            // --- DEBUG START ---
            console.log("Generated mailto link:", mailtoLink);
            alert("Check the console for the generated mailto link. Trying to open email client now..."); // This confirms the function is running.
            // --- DEBUG END ---

            window.location.href = mailtoLink;
        }


        async function startDrafting(oppId) {
            if (!currentUser) return alert("Please wait for user profile to load.");
            try {
                await sbClient.from('partner_opportunities').update({ status: 'In Progress', claimed_by: currentUser }).eq('id', oppId);
                window.location.href = "SubmitProposal.html";
            } catch (e) {
                console.error(e);
                alert("Error starting draft.");
            }
        }

        function toggleArchives() {
            showArchived = !showArchived;
            const btn = document.getElementById('toggle-archives-btn');
            if (showArchived) {
                btn.textContent = "Show Active"; btn.classList.replace('bg-gray-200', 'bg-gray-800'); btn.classList.replace('text-gray-700', 'text-white');
            } else {
                btn.textContent = "Show Archives"; btn.classList.replace('bg-gray-800', 'bg-gray-200'); btn.classList.replace('text-white', 'text-gray-700');
            }
            fetchMyProposals();
        }

        async function fetchMyProposals() {
            const tbody = document.getElementById('my-proposals-body');
            if (!tbody) return;
            tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-400 animate-pulse">Loading proposals...</td></tr>`;
            try {
                let query = sbClient.from('faculty_extension_proposals').select('*').order('created_at', { ascending: false });
                query = showArchived ? query.eq('status', 'Archived') : query.neq('status', 'Archived');

                const { data, error } = await query;
                if (error) throw error;

                if (!data || data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">${showArchived ? "Archive is empty." : "No active proposals found."}</td></tr>`;
                    return;
                }

                tbody.innerHTML = data.map(proposal => {
                    const dateStr = new Date(proposal.created_at).toLocaleDateString();
                    let statusClass = 'bg-yellow-100 text-yellow-800';
                    if (proposal.status === 'Approved') statusClass = 'bg-green-100 text-green-800';
                    if (proposal.status === 'Revision Requested') statusClass = 'bg-red-100 text-red-800';

                    const safeData = encodeURIComponent(JSON.stringify(proposal));
                    
                    // Check if there's a revision message
                    const hasRevision = proposal.status === 'Revision Requested' && proposal.revision_reason;
                    const revisionIndicator = hasRevision ? 
                        `<span class="inline-block w-2 h-2 bg-red-500 rounded-full animate-pulse ml-1" title="Revision Requested"></span>` : '';
                    
                    // Add revision icon with tooltip if there's a message
                    const revisionTooltip = hasRevision ? 
                        `<div class="relative inline-block ml-1 group">
                            <svg class="w-4 h-4 text-red-500 animate-bounce" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">
                                Revision Requested: Click to view details
                                <div class="absolute top-full left-1/2 transform -translate-x-1/2 -mt-1">
                                    <div class="w-2 h-2 bg-gray-900 rotate-45"></div>
                                </div>
                            </div>
                        </div>` : '';

                    let actionsHtml = '';

                    if (showArchived) {
                        actionsHtml = `
                            <button onclick="restoreProposal('${proposal.id}')" class="inline-flex items-center gap-2 text-sm font-bold text-green-600 hover:text-green-800 transition mr-2" title="Restore">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l4-4m-4 4l4 4" /></svg>
                                Restore
                            </button>
                            <button onclick="openDeleteModal('${proposal.id}')" class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-gray-400 hover:bg-red-100 hover:text-red-600 transition" title="Delete Permanently">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>`;
                    } else {
                        actionsHtml = `
                            <button onclick="openFacultyProposalModal('${safeData}')" class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition" title="View Details">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </button>
                            <a href="SubmitProposal.html?id=${proposal.id}" class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-gray-400 hover:bg-purple-50 hover:text-cnsc-500 transition" title="${hasRevision ? 'Make Revisions' : 'Edit Proposal'}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
                            </a>
                            <button onclick="openDeleteModal('${proposal.id}')" class="inline-flex items-center justify-center w-8 h-8 rounded-lg text-gray-400 hover:bg-red-100 hover:text-red-600 transition" title="Archive or Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>`;
                    }

                    return `
                        <tr class="border-b hover:bg-gray-50 transition ${hasRevision ? 'bg-red-50 hover:bg-red-100' : ''}">
                            <td class="px-6 py-4 font-bold text-gray-900">
                                <div class="flex items-center gap-2">
                                    ${proposal.title}
                                    ${revisionTooltip}
                                </div>
                                ${hasRevision ? '<div class="text-xs text-red-600 font-medium mt-1">Revision Requested - Click to view details</div>' : ''}
                            </td>
                            <td class="px-6 py-4">${dateStr}</td>
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-1">
                                    <span class="px-3 py-1 text-xs font-bold rounded-full ${statusClass}">${proposal.status}</span>
                                    ${revisionIndicator}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end items-center gap-2">${actionsHtml}</div>
                            </td>
                        </tr>`;
                }).join('');
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-500 bg-red-50"><strong>Error:</strong> ${error.message}</td></tr>`;
            }
        }


        async function fetchHandledProjects() {
            const grid = document.getElementById('handled-cards-grid');
            if (!grid || !currentUser) return;
            grid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10 animate-pulse">Loading your projects...</div>`;

            // The 'attachment_urls' column is now being selected
            const { data, error } = await sbClient.from('partner_opportunities').select('*, attachment_urls').eq('claimed_by', currentUser).order('created_at', { ascending: false });

            if (error || !data.length) {
                grid.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center text-gray-500 py-10"><p>No projects found for <strong>${currentUser}</strong>.</p></div>`;
                return;
            }

            grid.innerHTML = data.map(item => {
                const safeItem = encodeURIComponent(JSON.stringify(item));
                let badgeColor = 'bg-yellow-500';
                if (item.status === 'Completed') badgeColor = 'bg-green-500';
                if (item.status === 'In Progress') badgeColor = 'bg-blue-500';

                // Set a default placeholder image
                let coverImageUrl = `https://source.unsplash.com/random/400x300?work&sig=${item.id}`;
                // Check if there are any attachments
                if (item.attachment_urls && item.attachment_urls.length > 0) {
                    // Find the first URL that is an image file
                    const firstImage = item.attachment_urls.find(url => url && url.match(/\.(jpeg|jpg|gif|png|webp|avif)$/i));
                    // If an image is found, use it as the cover
                    if (firstImage) {
                        coverImageUrl = firstImage;
                    }
                }

                return `
                <div class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition border border-gray-100 flex flex-col h-full group">
                    <div class="relative h-48">
                        <img src="${coverImageUrl}" class="w-full h-full object-cover transition group-hover:scale-110" alt="Project Cover">
                        <div class="absolute top-4 right-4 ${badgeColor} text-white text-xs font-bold px-3 py-1 rounded-full uppercase shadow-sm">${item.status}</div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <h3 class="text-xl font-bold text-gray-900 mb-2 line-clamp-1">${item.title}</h3>
                        <p class="text-gray-600 text-sm line-clamp-3 mb-4">${item.description || 'No description.'}</p>
                        <div class="mt-auto pt-4 border-t border-gray-100">
                            <div class="flex justify-between items-center text-xs text-gray-500 mb-4">
                                <span><strong>Lead:</strong> You</span>
                                <span><strong>Partner:</strong> ${item.partner_organization}</span>
                            </div>
                            <button onclick="openProjectModal('${safeItem}')" class="w-full py-2.5 rounded-lg border-2 border-cnsc-500 text-cnsc-600 font-bold text-sm hover:bg-cnsc-500 hover:text-white transition">Manage Project</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function fetchCompletedProjects() {
            const grid = document.getElementById('completed-cards-grid');
            if (!grid) return;
            grid.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10 animate-pulse">Loading archive...</div>`;

            // The 'attachment_urls' column is now being selected
            const { data, error } = await sbClient.from('partner_opportunities').select('*, attachment_urls').eq('status', 'Completed').order('created_at', { ascending: false });

            if (error || !data.length) {
                grid.innerHTML = `<div class="col-span-full text-center text-gray-500 py-10">No completed projects found.</div>`;
                return;
            }

            grid.innerHTML = data.map(item => {
                const safeItem = encodeURIComponent(JSON.stringify(item));

                let coverImageUrl = `https://source.unsplash.com/random/400x300?success&sig=${item.id}`;
                if (item.attachment_urls && item.attachment_urls.length > 0) {
                    const firstImage = item.attachment_urls.find(url => url && url.match(/\.(jpeg|jpg|gif|png|webp|avif)$/i));
                    if (firstImage) {
                        coverImageUrl = firstImage;
                    }
                }

                return `
                <div class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition border border-emerald-100 flex flex-col h-full group">
                    <div class="relative h-48">
                        <img src="${coverImageUrl}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition" alt="Project Cover">
                        <div class="absolute top-4 right-4 bg-emerald-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase shadow-sm">Completed</div>
                    </div>
                    <div class="p-6 flex-1 flex flex-col">
                        <h3 class="text-xl font-bold text-gray-900 mb-2 line-clamp-1">${item.title}</h3>
                        <p class="text-gray-600 text-sm line-clamp-3 mb-4">${item.description || 'Project successfully implemented.'}</p>
                        <div class="mt-auto pt-4 border-t border-gray-100">
                             <div class="flex justify-between items-center text-xs text-gray-500 mb-4">
                                <span><strong>Handled By:</strong> ${item.claimed_by || 'Team'}</span>
                                <span><strong>Date:</strong> ${new Date(item.created_at).toLocaleDateString()}</span>
                            </div>
                            <button onclick="openProjectModal('${safeItem}')" class="w-full py-2.5 rounded-lg border-2 border-emerald-600 text-emerald-600 font-bold text-sm hover:bg-emerald-600 hover:text-white transition">View Outcome</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }


        // --- MODALS (Open, Close, Control) ---
        function openDeleteModal(id) { selectedProposalId = id; const m = document.getElementById('delete-modal'); const c = document.getElementById('delete-modal-content'); if (!m || !c) return; m.classList.remove('hidden'); setTimeout(() => { c.classList.remove('scale-95', 'opacity-0'); c.classList.add('scale-100', 'opacity-100'); }, 10); }
        function closeDeleteModal() { const m = document.getElementById('delete-modal'); const c = document.getElementById('delete-modal-content'); if (!m || !c) return; c.classList.remove('scale-100', 'opacity-100'); c.classList.add('scale-95', 'opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); selectedProposalId = null; }
        async function confirmArchive() { if (!selectedProposalId) return; await sbClient.from('faculty_extension_proposals').update({ status: 'Archived' }).eq('id', selectedProposalId); closeDeleteModal(); fetchMyProposals(); }
        async function confirmHardDelete() { if (!selectedProposalId || !confirm("Are you sure?")) return; await sbClient.from('faculty_extension_proposals').delete().eq('id', selectedProposalId); closeDeleteModal(); fetchMyProposals(); }
        async function restoreProposal(id) { if (!confirm("Restore?")) return; await sbClient.from('faculty_extension_proposals').update({ status: 'Pending' }).eq('id', id); fetchMyProposals(); }

        function openProjectModal(encodedItem) {
            try {
                const data = JSON.parse(decodeURIComponent(encodedItem));
                currentProjectId = data.id;

                const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val || "N/A"; }
                const setVal = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ""; }

                // Populate read-only view
                setText('pm-title', data.title);
                setText('pm-desc', data.description || data.rationale);
                setText('pm-partner', data.partner_organization);
                setText('pm-lead', data.claimed_by || "Team");
                setText('pm-lead-3', data.claimed_by || "Team");

                const rawDate = data.date_started || data.created_at;
                let dateStr = "N/A", dateInputVal = "";
                if (rawDate) { const d = new Date(rawDate); if (!isNaN(d.getTime())) { dateStr = d.toLocaleDateString(); dateInputVal = d.toISOString().split('T')[0]; } }
                setText('pm-date', dateStr);

                const statusEl = document.getElementById('pm-status');
                if (statusEl) {
                    statusEl.textContent = data.status;
                    statusEl.className = 'text-xs font-bold px-2 py-1 rounded uppercase text-white ';
                    if (data.status === 'Completed') statusEl.classList.add('bg-green-500');
                    else if (data.status === 'In Progress') statusEl.classList.add('bg-blue-500');
                    else statusEl.classList.add('bg-gray-500');
                }

                // Populate edit form
                setVal('edit-title', data.title);
                setVal('edit-partner', data.partner_organization);
                setVal('edit-status', data.status);
                setVal('edit-desc', data.description || data.rationale);
                setVal('edit-date', dateInputVal);
                setVal('edit-date-completed', data.date_completed ? new Date(data.date_completed).toISOString().split('T')[0] : "");
                toggleCompletionDate();

                // Access control
                const isOwner = data.claimed_by === currentUser;
                document.getElementById('btn-update-project').classList.toggle('hidden', !isOwner);
                document.getElementById('btn-manage-tab').classList.toggle('hidden', !isOwner);

                renderAttachments(data.attachment_urls, isOwner);
                switchTab('overview', document.querySelector('#project-modal .tab-btn'));
                document.getElementById('project-modal').classList.remove('hidden');

            } catch (e) {
                console.error("Error opening modal:", e);
                alert("Details could not be loaded.");
            }
        }

        function closeProjectModal() { document.getElementById('project-modal').classList.add('hidden'); }

        function switchTab(tabName, btnClicked) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-cnsc-500', 'text-cnsc-500', 'font-bold');
                btn.classList.add('border-transparent', 'text-gray-500', 'font-medium');
            });
            if (btnClicked) {
                btnClicked.classList.remove('border-transparent', 'text-gray-500', 'font-medium');
                btnClicked.classList.add('border-cnsc-500', 'text-cnsc-500', 'font-bold');
            }
        }

        function switchToManageTab() { switchTab('manage', document.getElementById('btn-manage-tab')); }

        function toggleCompletionDate() {
            const wrapper = document.getElementById('completion-date-wrapper');
            const dateInput = document.getElementById('edit-date-completed');
            if (document.getElementById('edit-status').value === 'Completed') {
                wrapper.classList.remove('hidden');
                if (!dateInput.value) dateInput.value = new Date().toISOString().split('T')[0];
            } else {
                wrapper.classList.add('hidden');
                dateInput.value = '';
            }
        }

        async function saveAllChanges() {
            const newTitle = document.getElementById('edit-title').value;
            const newPartner = document.getElementById('edit-partner').value;
            const newStatus = document.getElementById('edit-status').value;
            const newDesc = document.getElementById('edit-desc').value;
            const newDate = document.getElementById('edit-date').value;
            const completionDate = document.getElementById('edit-date-completed').value;

            if (newStatus === 'Completed' && !completionDate) return alert("Please enter the Date Finished.");
            if (!currentProjectId) return;

            const btn = event.target;
            btn.innerText = "Saving..."; btn.disabled = true;

            const { error } = await sbClient.from('partner_opportunities').update({
                title: newTitle, partner_organization: newPartner, status: newStatus,
                description: newDesc, date_started: newDate, date_completed: completionDate
            }).eq('id', currentProjectId);

            if (error) {
                alert("Error: " + error.message);
            } else {
                if (newStatus === 'Completed') {
                    await sendSystemNotification(currentUser, `Project "${newTitle}" marked as Completed!`, 'success');
                } else {
                    alert("Project updated successfully!");
                }
                closeProjectModal();
                fetchHandledProjects();
                fetchCompletedProjects();
            }
            btn.innerText = "Save Changes"; btn.disabled = false;
        }

        // --- FILE & ATTACHMENT MANAGEMENT ---
        async function handleFileUpload(input) {
            if (!input.files.length || !currentProjectId) return;
            const status = document.getElementById('upload-status');
            status.innerHTML = '<span class="text-blue-500 animate-pulse">Uploading...</span>';

            try {
                const newUrls = [];
                for (const file of input.files) {
                    const name = `${currentProjectId}/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    await sbClient.storage.from('project-files').upload(name, file);
                    const { data } = sbClient.storage.from('project-files').getPublicUrl(name);
                    newUrls.push(data.publicUrl);
                }

                const { data } = await sbClient.from('partner_opportunities').select('attachment_urls').eq('id', currentProjectId).single();
                const combined = [...(data.attachment_urls || []), ...newUrls];
                await sbClient.from('partner_opportunities').update({ attachment_urls: combined }).eq('id', currentProjectId);

                status.innerHTML = '<span class="text-green-600 font-bold">Done!</span>';
                renderAttachments(combined, true);
                setTimeout(() => {
                    switchTab('docs', document.querySelectorAll('.tab-btn')[2]);
                    status.innerHTML = '';
                }, 800);

            } catch (e) {
                console.error(e);
                status.innerHTML = `<span class="text-red-500">Error: ${e.message}</span>`;
            }
        }

        async function deleteAttachment(encodedUrl) {
            if (!confirm("Delete this file permanently?")) return;
            const urlToDelete = decodeURIComponent(encodedUrl);
            try {
                const { data } = await sbClient.from('partner_opportunities').select('attachment_urls').eq('id', currentProjectId).single();
                if (!data) return;
                const updatedUrls = data.attachment_urls.filter(u => u !== urlToDelete);
                const { error } = await sbClient.from('partner_opportunities').update({ attachment_urls: updatedUrls }).eq('id', currentProjectId);
                if (error) throw error;

                // Also delete from storage
                const filePath = urlToDelete.split('/project-files/')[1];
                if (filePath) await sbClient.storage.from('project-files').remove([filePath]);

                renderAttachments(updatedUrls, true);
            } catch (e) { console.error(e); alert("Delete failed."); }
        }

        function renderAttachments(urls, isOwner = false) {
            const container = document.getElementById('pm-attachments');
            if (!container) return;
            container.innerHTML = '';
            if (urls && urls.length > 0) {
                urls.forEach((url, i) => {
                    const isImg = url.match(/\.(jpeg|jpg|gif|png|webp|avif)$/i) != null;
                    const deleteBtn = isOwner ? `<button onclick="deleteAttachment('${encodeURIComponent(url)}')" class="absolute top-2 right-2 bg-red-600 text-white p-1.5 rounded-full shadow-md hover:bg-red-700 transition opacity-0 group-hover:opacity-100 z-20" title="Delete">🗑️</button>` : '';
                    const content = isImg ? `<img src="${url}" class="w-full h-32 object-cover transition group-hover:scale-110"><div class="p-2 bg-white text-xs font-bold text-gray-700">Image ${i + 1}</div>` : `<div class="flex items-center justify-center h-32 text-gray-400">📄</div><div class="p-2 bg-white text-xs font-bold text-center text-gray-700">Document ${i + 1}</div>`;
                    container.innerHTML += `<div class="relative group block overflow-hidden rounded-lg border border-gray-200 hover:shadow-md transition bg-gray-100">${deleteBtn}<a href="${url}" target="_blank" class="block h-full">${content}</a></div>`;
                });
            } else {
                container.innerHTML = '<p class="col-span-full text-gray-400 italic text-sm text-center py-4">No files uploaded yet.</p>';
            }
        }

        // --- NOTIFICATIONS & EMAIL ---
        async function fetchNotifications() {
            if (!currentUser) return;
            const { data, error } = await sbClient.from('faculty_notifications').select('*').eq('recipient', currentUser).order('created_at', { ascending: false }).limit(10);
            if (error) return console.error("Notif Error:", error);
            renderNotificationsUI(data);
        }

        function renderNotificationsUI(data) {
            const list = document.getElementById('notif-list');
            const badge = document.getElementById('notif-badge');
            list.innerHTML = '';
            const unreadCount = data.filter(n => !n.is_read).length;
            if (unreadCount > 0) badge.classList.remove('hidden'); else badge.classList.add('hidden');
            if (data.length === 0) {
                list.innerHTML = `<div class="p-4 text-center text-gray-400 text-xs italic">No new notifications</div>`;
                return;
            }
            data.forEach(n => {
                const bgClass = n.is_read ? 'bg-white' : 'bg-purple-50';
                list.innerHTML += `
                    <div class="p-3 ${bgClass} border-b border-gray-50 flex gap-3 hover:bg-gray-100 transition cursor-pointer">
                        <div class="h-2 w-2 rounded-full bg-blue-500 mt-1.5"></div>
                        <div>
                            <p class="text-sm text-gray-800">${n.message}</p>
                            <p class="text-[10px] text-gray-400 mt-1">${new Date(n.created_at).toLocaleString()}</p>
                        </div>
                    </div>`;
            });
        }

        async function markAllAsRead() {
            await sbClient.from('notifications').update({ is_read: true }).eq('recipient', currentUser);
            fetchNotifications();
        }

        async function sendSystemNotification(recipientName, message, type) {
            await sbClient.from('notifications').insert({ recipient: recipientName, message: message, type: type });
            simulateEmailSending(recipientName, message);
            fetchNotifications();
        }

        function simulateEmailSending(name, msg) {
            const toast = document.createElement('div');
            toast.className = "fixed bottom-5 right-5 bg-gray-900 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-[200] animate-pulse";
            toast.innerHTML = `<span>⏳</span><div><p class="font-bold text-sm">Sending Email...</p></div>`;
            document.body.appendChild(toast);

            const templateParams = { name: name, to_email: currentUserEmail, message: msg, subject: "Project Update" };

            emailjs.send('service_gyl0q9g', 'template_q40yoyg', templateParams)
                .then(function (response) {
                    toast.classList.remove('animate-pulse');
                    toast.innerHTML = `<span>✅</span><div><p class="font-bold text-sm">Email Sent Successfully!</p></div>`;
                    setTimeout(() => toast.remove(), 5000);
                }, function (error) {
                    toast.innerHTML = `<p class="text-red-400 font-bold">Email Failed: ${error.text}</p>`;
                });
        }

        // --- PROFILE MODAL ---
        function openProfileModal(section) { const m = document.getElementById('profile-modal'); if (!m) return; m.classList.remove('hidden'); if (section === 'settings') switchProfileTab('security'); else switchProfileTab('general'); }
        function closeProfileModal() { const m = document.getElementById('profile-modal'); if (m) m.classList.add('hidden'); }
        function switchProfileTab(which) {
            document.querySelectorAll('#profile-modal .profile-tab').forEach(t => t.classList.remove('active-tab', 'border-cnsc-500', 'text-cnsc-500', 'font-bold'));
            document.querySelectorAll('#ptab-general, #ptab-security').forEach(p => p.classList.add('hidden'));
            document.getElementById(`ptab-${which}`).classList.remove('hidden');
            const btn = document.querySelector(`.profile-tab[onclick*="'${which}'"]`);
            if (btn) btn.classList.add('active-tab', 'border-cnsc-500', 'text-cnsc-500', 'font-bold');
        }

        // --- ACCOUNT CARD POPUP ---
        function openAccountCard() {
            const ov = document.getElementById('account-card-overlay');
            const card = document.getElementById('account-card');
            if (!ov || !card) return;
            ov.classList.remove('hidden');
            card.classList.remove('hidden');
        }
        function closeAccountCard() {
            const ov = document.getElementById('account-card-overlay');
            const card = document.getElementById('account-card');
            if (ov) ov.classList.add('hidden');
            if (card) card.classList.add('hidden');
        }

        // --- FACULTY PROPOSAL MODAL WITH REVISION MESSAGES ---
        
        // Open faculty proposal modal with revision details
        function openFacultyProposalModal(encodedData) {
            try {
                const proposal = JSON.parse(decodeURIComponent(encodedData));
                
                // Set basic info
                document.getElementById('faculty-proposal-title').textContent = proposal.title || 'Untitled Proposal';
                document.getElementById('faculty-proposal-id').textContent = `ID: ${proposal.id ? proposal.id.substring(0, 8) + '...' : 'N/A'}`;
                
                // Set status badge
                const statusBadge = document.getElementById('faculty-proposal-status-badge');
                let statusClass = 'bg-yellow-100 text-yellow-800';
                let statusText = proposal.status || 'Pending';
                
                if (proposal.status === 'Approved') {
                    statusClass = 'bg-green-100 text-green-800';
                } else if (proposal.status === 'Revision Requested') {
                    statusClass = 'bg-red-100 text-red-800';
                } else if (proposal.status === 'Archived') {
                    statusClass = 'bg-gray-100 text-gray-800';
                }
                
                statusBadge.innerHTML = `<span class="px-3 py-1 text-sm font-bold rounded-full ${statusClass}">${statusText}</span>`;
                
                // Check if revision requested
                const hasRevision = proposal.status === 'Revision Requested' && proposal.revision_reason;
                const revisionAlert = document.getElementById('faculty-revision-alert');
                const actionRequired = document.getElementById('faculty-action-required');
                
                if (hasRevision) {
                    revisionAlert.classList.remove('hidden');
                    actionRequired.classList.remove('hidden');
                    
                    // Set revision details
                    document.getElementById('faculty-revision-reason').textContent = proposal.revision_reason || 'No specific reason provided.';
                    
                    // Format revision date
                    if (proposal.revision_requested_at) {
                        const revisionDate = new Date(proposal.revision_requested_at);
                        document.getElementById('faculty-revision-date').textContent = revisionDate.toLocaleString();
                        document.getElementById('faculty-timeline-revision-date').textContent = revisionDate.toLocaleString();
                    } else {
                        document.getElementById('faculty-revision-date').textContent = 'Date not available';
                        document.getElementById('faculty-timeline-revision-date').textContent = 'Date not available';
                    }
                    
                    // Show revision in timeline
                    document.getElementById('faculty-timeline-revision').classList.remove('hidden');
                    
                    // Update edit button text
                    document.getElementById('faculty-edit-button').innerHTML = `
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                        </svg>
                        Make Revisions
                    `;
                } else {
                    revisionAlert.classList.add('hidden');
                    actionRequired.classList.add('hidden');
                    document.getElementById('faculty-timeline-revision').classList.add('hidden');
                    
                    // Update edit button text
                    document.getElementById('faculty-edit-button').innerHTML = `
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                        </svg>
                        Edit Proposal
                    `;
                }
                
                // Set proposal details
                document.getElementById('faculty-proponents').textContent = proposal.proponents || 'N/A';
                document.getElementById('faculty-project-type').textContent = proposal.project_type || 'N/A';
                document.getElementById('faculty-budget').textContent = proposal.budget_requirement ? 
                    '$' + parseFloat(proposal.budget_requirement).toLocaleString() : 'N/A';
                document.getElementById('faculty-implementation-days').textContent = proposal.implementation_days || 'N/A';
                document.getElementById('faculty-rationale').textContent = proposal.rationale || 'No rationale provided.';
                
                // Set beneficiaries
                document.getElementById('faculty-beneficiaries-count').textContent = proposal.beneficiaries_count || 'N/A';
                document.getElementById('faculty-beneficiaries-type').textContent = proposal.beneficiaries_type || 'N/A';
                document.getElementById('faculty-beneficiaries-location').textContent = proposal.beneficiaries_location || 'N/A';
                
                // Set additional info
                document.getElementById('faculty-date-started').textContent = proposal.date_started || 'N/A';
                document.getElementById('faculty-attachment-unit').textContent = proposal.attachment_unit || 'N/A';
                document.getElementById('faculty-metric-value').textContent = proposal.matric_value || proposal.metric_value || 'N/A';
                
                // Format dates
                const createdDate = new Date(proposal.created_at);
                const updatedDate = proposal.updated_at ? new Date(proposal.updated_at) : createdDate;
                
                document.getElementById('faculty-created-date').textContent = createdDate.toLocaleDateString();
                document.getElementById('faculty-updated-date').textContent = updatedDate.toLocaleDateString();
                
                // Set timeline
                document.getElementById('faculty-timeline-created').textContent = createdDate.toLocaleString();
                document.getElementById('faculty-timeline-current-status').textContent = `${proposal.status || 'Pending'} as of ${updatedDate.toLocaleDateString()}`;
                
                // Store proposal ID for edit button
                window.currentFacultyProposalId = proposal.id;
                
                // Open modal
                const modal = document.getElementById('faculty-proposal-modal');
                modal.classList.remove('hidden');
                
                // Set first tab active
                switchFacultyTab('basic', document.querySelector('.faculty-tab.active-tab'));
                
            } catch (error) {
                console.error('Error opening faculty proposal modal:', error);
                alert('Failed to load proposal details.');
            }
        }

        // Close faculty proposal modal
        function closeFacultyProposalModal() {
            const modal = document.getElementById('faculty-proposal-modal');
            modal.classList.add('hidden');
            window.currentFacultyProposalId = null;
        }

        // Switch tabs in faculty proposal modal
        function switchFacultyTab(tabName, btnClicked) {
            // Hide all tab content
            document.querySelectorAll('.faculty-tab-content').forEach(p => p.classList.add('hidden'));
            
            // Show selected tab content
            document.getElementById(`faculty-tab-${tabName}`).classList.remove('hidden');
            
            // Update tab buttons
            document.querySelectorAll('.faculty-tab').forEach(btn => {
                btn.classList.remove('active-tab', 'border-cnsc-500', 'text-cnsc-500', 'font-bold');
                btn.classList.add('border-transparent', 'text-gray-500', 'font-medium');
            });
            
            if (btnClicked) {
                btnClicked.classList.remove('border-transparent', 'text-gray-500', 'font-medium');
                btnClicked.classList.add('active-tab', 'border-cnsc-500', 'text-cnsc-500', 'font-bold');
            }
        }

        // Go to edit proposal page
        function goToEditProposal() {
            if (window.currentFacultyProposalId) {
                window.location.href = `SubmitProposal.html?id=${window.currentFacultyProposalId}`;
            } else {
                alert('No proposal selected for editing.');
            }
        }

    </script>

    <!-- Account Popup Card -->
    <div id="account-card-overlay" class="fixed inset-0 bg-black/50 hidden z-[120]" onclick="closeAccountCard()"></div>
    <div id="account-card" class="fixed inset-0 z-[130] hidden flex items-end md:items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-5 relative border border-gray-100"
            onclick="event.stopPropagation()">
            <button class="absolute top-3 right-3 text-gray-400 hover:text-gray-600" onclick="closeAccountCard()"
                aria-label="Close">✕</button>
            <div class="flex items-center gap-3 mb-4">
                <img id="account-avatar" src="" class="w-12 h-12 rounded-full border" alt="Avatar">
                <div>
                    <div id="account-name" class="text-sm font-bold text-gray-900">...</div>
                    <div id="account-email" class="text-xs text-gray-500">...</div>
                </div>
                <span
                    class="ml-auto text-[10px] font-bold text-red-700 bg-red-100 border border-red-200 px-2 py-0.5 rounded-full uppercase">Faculty</span>
            </div>
            <div class="space-y-2">
                <button onclick="openProfileModal()"
                    class="w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-purple-50 hover:text-cnsc-500 transition">
                    <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    My Profile
                </button>
                <button onclick="openProfileModal('settings')"
                    class="w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-purple-50 hover:text-cnsc-500 transition">
                    <svg class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Settings
                </button>
                <button onclick="App.toggleDarkMode()"
                    class="w-full flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-lg hover:bg-gray-50 transition">
                    <svg id="theme-icon-card" class="w-5 h-5 mr-3 text-gray-400" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    Dark Mode
                </button>
                <div class="pt-2 border-t border-gray-100">
                    <button onclick="App.logout()"
                        class="w-full flex items-center px-3 py-2 text-sm font-bold text-red-600 rounded-lg hover:bg-red-50 transition">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Faculty Proposal Details Modal -->
    <div id="faculty-proposal-modal" class="fixed inset-0 z-[110] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-black/60 transition-opacity" onclick="closeFacultyProposalModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl border-0">
                    <!-- Modal Header -->
                    <div class="bg-white px-6 pt-6 pb-2">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 id="faculty-proposal-title" class="text-2xl font-bold text-gray-900">Proposal Details</h3>
                                <p id="faculty-proposal-id" class="text-sm text-gray-500 mt-1"></p>
                            </div>
                            <button type="button" onclick="closeFacultyProposalModal()"
                                class="text-gray-400 hover:text-gray-600 bg-gray-100 hover:bg-gray-200 rounded-full p-2 transition">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        <!-- Status Badge -->
                        <div id="faculty-proposal-status-badge" class="inline-block mb-4"></div>
                        
                        <!-- Revision Alert (Only shows if revision requested) -->
                        <div id="faculty-revision-alert" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-red-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-red-800 mb-1">Revision Requested by Admin</h4>
                                    <p id="faculty-revision-reason" class="text-red-700 mb-2"></p>
                                    <div class="text-xs text-red-600">
                                        <p><strong>Requested at:</strong> <span id="faculty-revision-date"></span></p>
                                        <p><strong>Please revise your proposal and resubmit for review.</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="bg-gray-50 px-6 pt-4 pb-6">
                        <!-- Tab Navigation -->
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="switchFacultyTab('basic', this)" class="faculty-tab active-tab">Basic Info</button>
                                <button onclick="switchFacultyTab('details', this)" class="faculty-tab">Project Details</button>
                                <button onclick="switchFacultyTab('timeline', this)" class="faculty-tab">Timeline</button>
                            </nav>
                        </div>

                        <!-- Tab Content -->
                        <div id="faculty-tab-basic" class="faculty-tab-content space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-3">Proposal Information</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Proponents</p>
                                            <p id="faculty-proponents" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Project Type</p>
                                            <p id="faculty-project-type" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Submission Date</p>
                                            <p id="faculty-created-date" class="font-medium text-gray-900"></p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-3">Budget & Implementation</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Budget Requirement</p>
                                            <p id="faculty-budget" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Implementation Days</p>
                                            <p id="faculty-implementation-days" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Last Updated</p>
                                            <p id="faculty-updated-date" class="font-medium text-gray-900"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold text-gray-900 mb-3">Rationale</h4>
                                <div id="faculty-rationale" class="p-4 bg-white rounded-lg border border-gray-200 text-gray-700"></div>
                            </div>
                        </div>

                        <div id="faculty-tab-details" class="faculty-tab-content hidden space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-3">Beneficiaries</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Count</p>
                                            <p id="faculty-beneficiaries-count" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Type</p>
                                            <p id="faculty-beneficiaries-type" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Location</p>
                                            <p id="faculty-beneficiaries-location" class="font-medium text-gray-900"></p>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-bold text-gray-900 mb-3">Additional Information</h4>
                                    <div class="space-y-3">
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Date Started</p>
                                            <p id="faculty-date-started" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Attachment Unit</p>
                                            <p id="faculty-attachment-unit" class="font-medium text-gray-900"></p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-500 uppercase font-semibold">Metric Value</p>
                                            <p id="faculty-metric-value" class="font-medium text-gray-900"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="faculty-tab-timeline" class="faculty-tab-content hidden">
                            <div class="space-y-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Proposal Created</p>
                                        <p id="faculty-timeline-created" class="text-sm text-gray-500"></p>
                                    </div>
                                </div>
                                
                                <div id="faculty-timeline-revision" class="hidden">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
                                            <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                                            </svg>
                                        </div>
                                        <div>
                                            <p class="font-medium text-red-800">Revision Requested</p>
                                            <p id="faculty-timeline-revision-date" class="text-sm text-red-600"></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1.323l3.954 1.582 1.599-.8a1 1 0 01.894 1.79l-1.233.616 1.738 5.42a1 1 0 01-.285 1.05A3.989 3.989 0 0115 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.715-5.349L11 6.477V16h2a1 1 0 110 2H7a1 1 0 110-2h2V6.477L6.237 7.582l1.715 5.349a1 1 0 01-.285 1.05A3.989 3.989 0 015 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.738-5.42-1.233-.617a1 1 0 01.894-1.788l1.599.799L9 4.323V3a1 1 0 011-1z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-medium text-gray-900">Current Status</p>
                                        <p id="faculty-timeline-current-status" class="text-sm text-gray-500"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-between items-center">
                        <div>
                            <span id="faculty-action-required" class="hidden text-sm font-medium text-red-600 animate-pulse">
                                Action Required: Please revise your proposal
                            </span>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="closeFacultyProposalModal()" class="btn btn-secondary">Close</button>
                            <button onclick="goToEditProposal()" id="faculty-edit-button" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" />
                                </svg>
                                Edit Proposal
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals (Project, Delete, Profile) -->
    <div id="project-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-black/60 transition-opacity" onclick="closeProjectModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-5xl border-0">
                    <div class="relative h-48 md:h-64 bg-gray-900">
                        <img id="pm-banner"
                            src="https://images.unsplash.com/photo-1531403009284-440f080d1e12?q=80&w=2070&auto=format&fit=crop"
                            class="w-full h-full object-cover opacity-50" alt="Cover">
                        <div class="absolute inset-0 flex flex-col justify-end p-6 md:p-8">
                            <div class="flex items-center space-x-3 mb-2">
                                <span id="pm-status"
                                    class="bg-green-500 text-white text-xs font-bold px-2 py-1 rounded uppercase">...</span>
                                <span
                                    class="bg-cnsc-500 text-white text-xs font-bold px-2 py-1 rounded uppercase">Extension</span>
                            </div>
                            <h2 id="pm-title"
                                class="text-2xl md:text-4xl font-bold text-white leading-tight drop-shadow-md">Project
                                Title</h2>
                            <button type="button" onclick="closeProjectModal()"
                                class="absolute top-4 right-4 text-white/80 hover:text-white bg-black/20 rounded-full p-2">✕</button>
                        </div>
                    </div>
                    <div class="bg-white border-b border-gray-200 px-6 pt-2">
                        <nav class="-mb-px flex space-x-8">
                            <button onclick="switchTab('overview', this)" class="tab-btn active-tab">Overview</button>
                            <button onclick="switchTab('team', this)" class="tab-btn">Team</button>
                            <button onclick="switchTab('docs', this)" class="tab-btn">Gallery & Docs</button>
                            <button id="btn-manage-tab" onclick="switchTab('manage', this)"
                                class="hidden tab-btn border-transparent text-orange-600 whitespace-nowrap py-4 px-1 border-b-2 font-bold text-sm">Manage
                                Project</button>
                        </nav>
                    </div>
                    <div class="bg-gray-50 p-6 md:p-8 min-h-[300px]">
                        <div id="tab-overview" class="tab-pane block">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2 space-y-6">
                                    <div>
                                        <h4 class="font-bold text-gray-900 mb-2">Description</h4>
                                        <p id="pm-desc" class="text-sm text-gray-600 whitespace-pre-wrap">...</p>
                                    </div>
                                </div>
                                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-fit space-y-4">
                                    <div>
                                        <p class="text-xs text-gray-500">Partner</p>
                                        <p id="pm-partner" class="font-bold text-gray-800">...</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Date Started</p>
                                        <p id="pm-date" class="font-bold text-gray-800">...</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-500">Lead</p>
                                        <p id="pm-lead" class="font-bold text-cnsc-500">...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="tab-team" class="tab-pane hidden">
                            <h4 class="font-bold text-gray-900 mb-6">Project Lead</h4>
                            <div class="flex items-center bg-white p-4 rounded-xl border shadow-sm max-w-md">
                                <div
                                    class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-cnsc-500 font-bold mr-4">
                                    PL</div>
                                <div>
                                    <h5 id="pm-lead-3" class="font-bold text-sm">...</h5>
                                    <p class="text-xs text-gray-500">Project Leader</p>
                                </div>
                            </div>
                        </div>
                        <div id="tab-docs" class="tab-pane hidden">
                            <h4 class="font-bold text-gray-900 mb-4">Attachments</h4>
                            <div id="pm-attachments" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
                        </div>
                        <div id="tab-manage" class="tab-pane hidden">
                            <div class="max-w-3xl mx-auto space-y-6">
                                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                    <h4 class="font-bold text-gray-900 mb-4">Edit Details</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        <div class="md:col-span-2"><label
                                                class="text-xs font-bold text-gray-700 uppercase mb-1">Title</label><input
                                                type="text" id="edit-title" class="input"></div>
                                        <div><label
                                                class="text-xs font-bold text-gray-700 uppercase mb-1">Partner</label><input
                                                type="text" id="edit-partner" class="input"></div>
                                        <div><label class="text-xs font-bold text-gray-700 uppercase mb-1">Date
                                                Started</label><input type="date" id="edit-date" class="input"></div>
                                        <div><label
                                                class="text-xs font-bold text-gray-700 uppercase mb-1">Status</label><select
                                                id="edit-status" onchange="toggleCompletionDate()" class="input">
                                                <option value="New">New</option>
                                                <option value="In Progress">In Progress</option>
                                                <option value="Completed">Completed</option>
                                            </select></div>
                                        <div id="completion-date-wrapper"
                                            class="hidden md:col-span-2 bg-green-50 p-3 rounded border border-green-200 mt-2">
                                            <label class="text-xs font-bold text-green-800 uppercase mb-1">Date Finished
                                                (Required)</label>
                                            <input type="date" id="edit-date-completed"
                                                class="input bg-white border-green-300">
                                        </div>
                                        <div class="md:col-span-2"><label
                                                class="text-xs font-bold text-gray-700 uppercase mb-1">Description</label><textarea
                                                id="edit-desc" rows="5" class="input"></textarea></div>
                                    </div>
                                    <div class="flex justify-end"><button onclick="saveAllChanges()"
                                            class="btn btn-primary">Save Changes</button></div>
                                </div>
                                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                                    <h4 class="font-bold text-gray-900 mb-2">Upload Files</h4>
                                    <label class="file-upload-zone flex flex-col items-center justify-center h-32"><span
                                            class="text-sm text-gray-500">Click to upload or drag & drop</span><input
                                            type="file" id="dropzone-file" class="hidden" multiple
                                            onchange="handleFileUpload(this)"></label>
                                    <div id="upload-status" class="mt-2 text-sm text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 px-8 py-4 border-t border-gray-200 flex justify-end gap-3">
                        <button onclick="closeProjectModal()" class="btn btn-secondary">Close</button>
                        <button id="btn-update-project" onclick="switchToManageTab()"
                            class="hidden btn btn-primary">Update Project</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="delete-modal"
        class="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 hidden transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md transform transition-all m-4 scale-95 opacity-0"
            id="delete-modal-content">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                        </path>
                    </svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900">Delete Proposal?</h3>
                <p class="text-sm text-gray-500 mt-2"><strong>Archive:</strong> Hides it from the main
                    list.<br><strong>Delete:</strong> Removes it permanently.</p>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse gap-2">
                <button type="button" onclick="confirmHardDelete()" class="btn btn-danger w-full sm:w-auto">Delete
                    Permanently</button>
                <button type="button" onclick="confirmArchive()"
                    class="btn btn-secondary mt-3 sm:mt-0 w-full sm:w-auto">Archive</button>
                <button type="button" onclick="closeDeleteModal()"
                    class="btn btn-secondary mt-3 sm:mt-0 w-full sm:w-auto">Cancel</button>
            </div>
        </div>
    </div>
    <div id="profile-modal" class="fixed inset-0 z-[110] hidden" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeProfileModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4">
                <div
                    class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all w-full max-w-2xl">
                    <div class="bg-cnsc-500 h-32 relative">
                        <button onclick="closeProfileModal()"
                            class="absolute top-4 right-4 text-white/80 hover:text-white bg-black/20 hover:bg-black/40 rounded-full p-2 transition">✕</button>
                        <div class="absolute -bottom-10 left-8 group">
                            <div
                                class="relative w-24 h-24 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white">
                                <img id="modal-profile-img" src="" class="w-full h-full object-cover">
                                <label for="profile-upload"
                                    class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </label>
                                <input type="file" id="profile-upload" class="hidden" accept="image/*"
                                    onchange="previewProfileImage(this)">
                            </div>
                        </div>
                    </div>
                    <div class="pt-12 px-8 pb-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 id="profile-modal-name" class="text-2xl font-bold text-gray-900">...</h2>
                                <p class="text-sm text-gray-500">Faculty Head • College of Engineering</p>
                            </div>
                            <span
                                class="bg-red-100 text-red-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide border border-red-200">Faculty
                                Account</span>
                        </div>
                        <div class="border-b border-gray-200 mb-6">
                            <nav class="-mb-px flex space-x-8">
                                <button onclick="switchProfileTab('general')" class="profile-tab active-tab">General
                                    Info</button>
                                <button onclick="switchProfileTab('security')" class="profile-tab">Security &
                                    Password</button>
                            </nav>
                        </div>
                        <div id="ptab-general" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Full
                                        Name</label><input type="text" id="input-name" class="input"></div>
                                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Email
                                        Address</label><input type="email" id="input-email" class="input"></div>
                                <div class="md:col-span-2"><label
                                        class="block text-xs font-bold text-gray-700 uppercase mb-1">Professional
                                        Bio</label><textarea id="input-bio" rows="3" class="input"></textarea></div>
                            </div>
                        </div>
                        <div id="ptab-security" class="hidden space-y-4">
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <p class="text-sm text-yellow-700">Changing your password will sign you out of all other
                                    devices.</p>
                            </div>
                            <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Current
                                    Password</label><input type="password" placeholder="••••••••" class="input"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">New
                                        Password</label><input type="password" class="input"></div>
                                <div><label class="block text-xs font-bold text-gray-700 uppercase mb-1">Confirm
                                        Password</label><input type="password" class="input"></div>
                            </div>
                        </div>
                        <div class="mt-8 pt-4 border-t border-gray-100 flex justify-end gap-3">
                            <button onclick="closeProfileModal()" class="btn btn-secondary">Cancel</button>
                            <button onclick="saveProfileChanges()" class="btn btn-primary"><span>✓</span>Save
                                Changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>