<!-- SubmitProposal.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit New Proposal | CNSC Extension Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Hide all steps by default */
        [data-step]:not([data-step="1"]) {
            display: none;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #5A2C9D;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #4C2684;
        }

        /* Error styling */
        .error-field {
            border-color: #dc2626 !important;
        }
        .error-message {
            color: #dc2626;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        /* Success message */
        .success-message {
            background-color: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        /* Error message */
        .error-alert {
            background-color: #fee2e2;
            border-color: #ef4444;
            color: #7f1d1d;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cnsc-violet': '#5A2C9D',
                        'cnsc-violet-dark': '#4C2684',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-100">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cnsc-violet"></div>
            <p class="mt-4 text-lg font-medium text-gray-700">Submitting proposal...</p>
        </div>
    </div>

    <header class="sticky top-0 left-0 w-full bg-white shadow-md z-50">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <a href="#" class="flex items-center space-x-3">
                <img src="../logo.png" alt="CNSC Logo" class="h-10 w-10 rounded-full object-cover">
                <div class="leading-none hidden sm:block">
                    <p class="text-xs font-bold text-gray-800 tracking-wider">CNSC Extension Services</p>
                    <h1 class="text-xl font-extrabold text-cnsc-violet">Project Proposal Submission</h1>
                </div>
            </a>
            <div class="flex items-center gap-4">
                <span id="partnerInfo" class="text-sm text-gray-600 hidden"></span>
                <button onclick="closeWindow()" class="text-sm font-semibold text-gray-600 hover:text-cnsc-violet">&larr; Back to Dashboard</button>
            </div>
        </nav>
    </header>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-900">New Extension Project Proposal</h1>
                <p class="text-sm text-gray-500 mt-1" id="requestInfo">Fill out the form below, following the official format.</p>
            </div>

            <!-- Step Indicators -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-center" data-indicator="1">
                        <div class="w-8 h-8 rounded-full bg-cnsc-violet text-white font-bold flex items-center justify-center">1</div>
                        <span class="font-bold text-cnsc-violet text-xs sm:text-sm">Description</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
                    <div class="flex items-center gap-2 text-center" data-indicator="2">
                        <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 font-bold flex items-center justify-center">2</div>
                        <span class="font-bold text-gray-400 text-xs sm:text-sm">Staffing</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
                    <div class="flex items-center gap-2 text-center" data-indicator="3">
                        <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 font-bold flex items-center justify-center">3</div>
                        <span class="font-bold text-gray-400 text-xs sm:text-sm">Plan</span>
                    </div>
                    <div class="flex-1 h-0.5 bg-gray-200 mx-4"></div>
                    <div class="flex items-center gap-2 text-center" data-indicator="4">
                        <div class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 font-bold flex items-center justify-center">4</div>
                        <span class="font-bold text-gray-400 text-xs sm:text-sm">Submit</span>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="successMessage" class="hidden mx-8 mt-8 p-4 border rounded-lg success-message">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="font-medium">Proposal submitted successfully! Redirecting...</span>
                </div>
            </div>

            <div id="errorMessage" class="hidden mx-8 mt-8 p-4 border rounded-lg error-alert">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                    </svg>
                    <span id="errorText" class="font-medium"></span>
                </div>
            </div>

            <form id="proposal-form" class="p-8 space-y-8 custom-scrollbar" style="max-height: calc(100vh - 300px); overflow-y: auto;">
                <!-- Hidden fields for tracking -->
                <input type="hidden" id="requestId" name="requestId">
                <input type="hidden" id="projectId" name="projectId">

                <!-- STEP 1 -->
                <div data-step="1" class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">I. Project Description</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Project Title *</label>
                            <input type="text" name="title" id="projectTitle"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Type of Project *</label>
                            <select name="project_type" id="projectType"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required>
                                <option value="">Select type...</option>
                                <option value="research">Research Collaboration</option>
                                <option value="community">Community Extension</option>
                                <option value="training">Training Program</option>
                                <option value="internship">Internship Program</option>
                                <option value="consultancy">Consultancy Services</option>
                                <option value="infrastructure">Infrastructure Development</option>
                                <option value="environmental">Environmental Project</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Proponents (Organization Name)</label>
                            <input type="text" name="proponents" id="organizationName"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">No. of Beneficiaries *</label>
                            <input type="number" name="beneficiaries_no" id="beneficiariesNo"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required min="1">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Target Beneficiaries *</label>
                            <input type="text" name="beneficiaries_type" id="beneficiariesType"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                placeholder="e.g., Farmers, Students, Community Members" required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Location *</label>
                            <input type="text" name="location" id="location"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Start Date *</label>
                            <input type="date" name="start_date" id="startDate"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">End Date *</label>
                            <input type="date" name="end_date" id="endDate"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700">Total Budget (PHP) *</label>
                            <input type="number" name="budget_req" id="budgetReq" step="0.01" min="0"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                                required>
                            <div id="budget-error" class="error-message hidden">Please enter a valid budget amount</div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2 -->
                <div data-step="2" class="space-y-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">II. Rationale & Objectives</h2>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Project Rationale *</label>
                        <textarea name="rationale" rows="5" id="rationaleField"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet sm:text-sm"
                            placeholder="Explain the need for this project, its importance, and expected impact..."
                            required></textarea>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 border-b pb-2">III. Project Organization & Staffing</h2>
                        <p class="text-sm text-gray-600 mb-3">List the key personnel involved in this project:</p>
                        <div class="overflow-x-auto rounded-lg border border-gray-200 mt-4">
                            <table class="min-w-full divide-y divide-gray-200" id="staff-table">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Name/Role *</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Responsibilities *</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Contact Person</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase">Contact No.</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200 staff-body">
                                    <!-- Dynamic staff rows go here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="staff-error" class="error-message hidden mt-2">Please add at least one staff member</div>
                        <button type="button" id="add-staff-btn"
                            class="mt-2 px-4 py-2 bg-cnsc-violet text-white text-sm font-bold rounded-lg hover:bg-cnsc-violet-dark transition">+ Add Staff Row</button>
                    </div>
                </div>

                <!-- STEP 3 -->
                <div data-step="3" class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">IV. Logical Framework</h2>

                    <!-- Goal Section -->
                    <div>
                        <label class="block text-sm font-bold text-gray-800 mb-2">1. Goal (Long-term Impact)</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Narrative Summary *</label>
                                <textarea name="goal_narrative" rows="3" id="goalNarrative"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet"
                                    placeholder="The broader, long-term impact (e.g., Improved community livelihood)"
                                    required></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Indicators *</label>
                                <textarea name="goal_indicators" rows="3" id="goalIndicators"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet"
                                    placeholder="How success will be measured"
                                    required></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Means of Verification *</label>
                                <textarea name="goal_movs" rows="3" id="goalMovs"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet"
                                    placeholder="How evidence will be collected"
                                    required></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Purpose Section -->
                    <div class="mt-6">
                        <label class="block text-sm font-bold text-gray-800 mb-2">2. Purpose (Project Outcome)</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-lg bg-gray-50">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Narrative Summary *</label>
                                <textarea name="purpose_narrative" rows="3" id="purposeNarrative"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet"
                                    placeholder="The specific outcome of the project"
                                    required></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Indicators *</label>
                                <textarea name="purpose_indicators" rows="3" id="purposeIndicators"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet"
                                    required></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Means of Verification *</label>
                                <textarea name="purpose_movs" rows="3" id="purposeMovs"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet"
                                    required></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Outputs Section (Dynamic) -->
                    <div class="mt-6">
                        <label class="block text-sm font-bold text-gray-800 mb-2">3. Outputs (Deliverables)</label>
                        <p class="text-xs text-gray-500 mb-3">The tangible deliverables of the project. You can add multiple outputs.</p>
                        <div id="logframe-outputs-container" class="space-y-4"></div>
                        <div id="output-error" class="error-message hidden mt-2">Please add at least one output</div>
                        <button type="button" id="add-output-btn"
                            class="mt-2 px-4 py-2 bg-cnsc-violet text-white text-sm font-bold rounded-lg hover:bg-cnsc-violet-dark transition">+ Add Output</button>
                    </div>
                </div>

                <!-- TEMPLATE for a single output row -->
                <template id="output-row-template">
                    <div class="p-4 border rounded-lg bg-gray-50 output-row relative">
                        <button type="button"
                            class="remove-output-btn absolute top-2 right-2 text-red-400 hover:text-red-600 font-bold"
                            title="Remove Output">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </button>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Narrative Summary *</label>
                                <textarea name="output_narrative[]" rows="3"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet output-field"
                                    placeholder="e.g., 50 garden beds built" required></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Indicators *</label>
                                <textarea name="output_indicators[]" rows="3"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet output-field"
                                    placeholder="e.g., 50 signed agreements" required></textarea>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-1">Means of Verification *</label>
                                <textarea name="output_movs[]" rows="3"
                                    class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-cnsc-violet focus:border-cnsc-violet output-field"
                                    placeholder="e.g., Signed agreements on file" required></textarea>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- STEP 4 -->
                <div data-step="4" class="space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2">V. Attachments & Final Review</h2>

                    <!-- Summary Review -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                        <h3 class="font-bold text-blue-800 mb-2">Proposal Summary</h3>
                        <div id="proposal-summary" class="text-sm text-blue-700">
                            <!-- Summary will be dynamically populated -->
                        </div>
                    </div>

                    <!-- Attachments -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-3">Required Attachments</h3>
                        <div class="space-y-3 mb-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="attachments_gantt" class="mr-2">
                                <label for="attachments_gantt" class="text-sm">Gantt Chart (Project Timeline)</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="attachments_budget" class="mr-2">
                                <label for="attachments_budget" class="text-sm">Detailed Budget Breakdown</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="attachments_monitoring" class="mr-2">
                                <label for="attachments_monitoring" class="text-sm">Monitoring & Evaluation Plan</label>
                            </div>
                        </div>

                        <div class="mt-6 p-6 border-2 border-dashed border-gray-300 rounded-lg" id="fileDropZone">
                            <label for="file-upload" class="block text-center cursor-pointer">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span class="mt-2 block text-sm font-medium text-gray-900">Upload supporting documents</span>
                                <span class="mt-1 block text-xs text-gray-500">DOCX, PDF, XLSX up to 10MB each</span>
                            </label>
                            <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple>
                        </div>
                        <div id="file-list" class="mt-3 text-sm text-gray-700"></div>
                    </div>

                    <!-- Declaration -->
                    <div class="mt-6 p-4 border border-gray-200 rounded-lg">
                        <div class="flex items-start">
                            <input type="checkbox" id="declaration" class="mt-1 mr-3" required>
                            <label for="declaration" class="text-sm">
                                <span class="font-bold text-gray-800">Declaration:</span> I certify that all information provided in this proposal is accurate and complete to the best of my knowledge. I understand that this proposal will be reviewed by CNSC faculty and may be subject to further inquiry.
                            </label>
                        </div>
                        <div id="declaration-error" class="error-message hidden mt-2">Please agree to the declaration</div>
                    </div>
                </div>

                <!-- BUTTONS -->
                <div class="pt-6 border-t border-gray-200 flex justify-between items-center">
                    <button type="button" id="prev-btn"
                        class="px-5 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg transition hidden">Previous</button>
                    <button type="button" id="next-btn"
                        class="ml-auto px-5 py-2 bg-cnsc-violet hover:bg-cnsc-violet-dark text-white font-bold rounded-lg shadow-md hover:shadow-lg transition">Next</button>
                    <button type="submit" id="submit-btn"
                        class="ml-auto px-5 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md hover:shadow-lg transition hidden">Submit Proposal</button>
                </div>
            </form>
        </div>
    </main>

    <!-- SINGLE SCRIPT SECTION WITH DATABASE INTEGRATION -->
    <script>
        // =================== SUPABASE INITIALIZATION ===================
        const supabaseUrl = 'https://fkdqenrxfanpgmtogiig.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrZHFlbnJ4ZmFucGdtdG9naWlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NDA1NzksImV4cCI6MjA4MDMxNjU3OX0.NSA57GQcxnCpLnqMVlDpf_lvfggb2H-IGGTBL_XYQ4I';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Global variables
        let currentStep = 1;
        const totalSteps = 4;
        window.files = [];
        let partnerData = {};

        // Global helper functions
        function showError(element, message) {
            if (!element) return;

            element.classList.add('error-field');
            element.focus();

            // Create error message element if it doesn't exist
            let errorDiv = element.nextElementSibling;
            if (!errorDiv || !errorDiv.classList.contains('error-message')) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                element.parentNode.insertBefore(errorDiv, element.nextSibling);
            }
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function clearErrors() {
            // Remove error styling
            document.querySelectorAll('.error-field').forEach(el => {
                el.classList.remove('error-field');
            });

            // Hide all error messages
            document.querySelectorAll('.error-message').forEach(el => {
                el.classList.add('hidden');
            });

            // Hide specific error divs
            const staffError = document.getElementById('staff-error');
            const outputError = document.getElementById('output-error');
            const declarationError = document.getElementById('declaration-error');

            if (staffError) staffError.classList.add('hidden');
            if (outputError) outputError.classList.add('hidden');
            if (declarationError) declarationError.classList.add('hidden');
        }

        function validateStep(step) {
            console.log(`Validating step ${step}`);

            // Clear previous errors
            clearErrors();

            let isValid = true;

            switch(step) {
                case 1:
                    // Check all required fields in step 1
                    const requiredFields1 = [
                        { id: 'projectTitle', name: 'Project Title' },
                        { id: 'projectType', name: 'Project Type' },
                        { id: 'beneficiariesNo', name: 'Number of Beneficiaries' },
                        { id: 'beneficiariesType', name: 'Target Beneficiaries' },
                        { id: 'location', name: 'Location' },
                        { id: 'startDate', name: 'Start Date' },
                        { id: 'endDate', name: 'End Date' },
                        { id: 'budgetReq', name: 'Total Budget' }
                    ];

                    for (const field of requiredFields1) {
                        const element = document.getElementById(field.id);
                        if (!element || !element.value.trim()) {
                            if (element) showError(element, `${field.name} is required`);
                            isValid = false;
                        }
                    }

                    // Special validation for budget
                    const budgetField = document.getElementById('budgetReq');
                    if (budgetField && budgetField.value && parseFloat(budgetField.value) <= 0) {
                        showError(budgetField, 'Budget must be greater than 0');
                        isValid = false;
                    }

                    // Date validation
                    const startDate = document.getElementById('startDate');
                    const endDate = document.getElementById('endDate');
                    if (startDate && endDate && startDate.value && endDate.value) {
                        const start = new Date(startDate.value);
                        const end = new Date(endDate.value);
                        if (end <= start) {
                            showError(endDate, 'End date must be after start date');
                            isValid = false;
                        }
                    }
                    break;

                case 2:
                    // Check rationale
                    const rationaleField = document.getElementById('rationaleField');
                    if (!rationaleField || !rationaleField.value.trim()) {
                        if (rationaleField) showError(rationaleField, 'Project Rationale is required');
                        isValid = false;
                    }

                    // Check staff rows
                    const staffRows = document.querySelectorAll('#staff-table tbody tr');
                    if (staffRows.length === 0) {
                        document.getElementById('staff-error').classList.remove('hidden');
                        isValid = false;
                    } else {
                        // Check each staff row for required fields
                        staffRows.forEach((row, index) => {
                            const nameInput = row.querySelector('[name="staff_name[]"]');
                            const responsibilitiesInput = row.querySelector('[name="staff_responsibilities[]"]');

                            if (!nameInput || !nameInput.value.trim()) {
                                if (nameInput) showError(nameInput, `Staff ${index + 1}: Name/Role is required`);
                                isValid = false;
                            }
                            if (!responsibilitiesInput || !responsibilitiesInput.value.trim()) {
                                if (responsibilitiesInput) showError(responsibilitiesInput, `Staff ${index + 1}: Responsibilities is required`);
                                isValid = false;
                            }
                        });
                    }
                    break;

                case 3:
                    // Check goal fields
                    const goalFields = [
                        { id: 'goalNarrative', name: 'Goal Narrative Summary' },
                        { id: 'goalIndicators', name: 'Goal Indicators' },
                        { id: 'goalMovs', name: 'Goal Means of Verification' },
                        { id: 'purposeNarrative', name: 'Purpose Narrative Summary' },
                        { id: 'purposeIndicators', name: 'Purpose Indicators' },
                        { id: 'purposeMovs', name: 'Purpose Means of Verification' }
                    ];

                    for (const field of goalFields) {
                        const element = document.getElementById(field.id);
                        if (!element || !element.value.trim()) {
                            if (element) showError(element, `${field.name} is required`);
                            isValid = false;
                        }
                    }

                    // Check outputs
                    const outputRows = document.querySelectorAll('.output-row');
                    if (outputRows.length === 0) {
                        document.getElementById('output-error').classList.remove('hidden');
                        isValid = false;
                    } else {
                        // Check each output row
                        outputRows.forEach((row, index) => {
                            const textareas = row.querySelectorAll('.output-field');
                            textareas.forEach(textarea => {
                                if (!textarea || !textarea.value.trim()) {
                                    if (textarea) showError(textarea, `Output ${index + 1}: All fields are required`);
                                    isValid = false;
                                }
                            });
                        });
                    }
                    break;

                case 4:
                    // Check declaration
                    const declarationCheckbox = document.getElementById('declaration');
                    if (!declarationCheckbox || !declarationCheckbox.checked) {
                        document.getElementById('declaration-error').classList.remove('hidden');
                        if (declarationCheckbox) declarationCheckbox.classList.add('error-field');
                        isValid = false;
                    }
                    break;
            }

            console.log(`Step ${step} validation result: ${isValid}`);
            return isValid;
        }

        function updateFormStep() {
            console.log(`Updating to step ${currentStep}`);

            // Hide all steps
            document.querySelectorAll('[data-step]').forEach(el => {
                el.style.display = 'none';
            });

            // Show current step
            const currentStepElement = document.querySelector(`[data-step="${currentStep}"]`);
            if (currentStepElement) {
                currentStepElement.style.display = 'block';
            }

            // Update step indicators
            document.querySelectorAll('[data-indicator]').forEach((el, index) => {
                const stepNum = index + 1;
                const circle = el.querySelector('div');
                const text = el.querySelector('span');

                if (circle) {
                    circle.className = 'w-8 h-8 rounded-full font-bold flex items-center justify-center transition-colors duration-200';
                    text.className = 'font-bold text-xs sm:text-sm transition-colors duration-200';

                    if (stepNum < currentStep) {
                        circle.classList.add('bg-green-500', 'text-white');
                        circle.innerHTML = 'âœ“';
                        text.classList.add('text-green-600');
                    } else if (stepNum === currentStep) {
                        circle.classList.add('bg-cnsc-violet', 'text-white');
                        circle.innerHTML = stepNum;
                        text.classList.add('text-cnsc-violet');
                    } else {
                        circle.classList.add('bg-gray-200', 'text-gray-500');
                        circle.innerHTML = stepNum;
                        text.classList.add('text-gray-400');
                    }
                }
            });

            // Update buttons visibility
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitBtn = document.getElementById('submit-btn');

            if (prevBtn) prevBtn.classList.toggle('hidden', currentStep === 1);
            if (nextBtn) nextBtn.classList.toggle('hidden', currentStep === totalSteps);
            if (submitBtn) submitBtn.classList.toggle('hidden', currentStep !== totalSteps);
        }

        function generateProposalSummary() {
            const form = document.getElementById('proposal-form');
            const summary = document.getElementById('proposal-summary');
            const staffRows = document.querySelectorAll('#staff-table tbody tr');

            if (form && summary) {
                const summaryHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div><strong>Project Title:</strong> ${form.title.value || 'Not set'}</div>
                        <div><strong>Project Type:</strong> ${form.project_type.value || 'Not set'}</div>
                        <div><strong>Organization:</strong> ${form.proponents.value || 'Not set'}</div>
                        <div><strong>Location:</strong> ${form.location.value || 'Not set'}</div>
                        <div><strong>Budget:</strong> PHP ${parseFloat(form.budget_req.value || 0).toLocaleString()}</div>
                        <div><strong>Duration:</strong> ${form.start_date.value || 'Not set'} to ${form.end_date.value || 'Not set'}</div>
                        <div><strong>Beneficiaries:</strong> ${form.beneficiaries_no.value || '0'} ${form.beneficiaries_type.value || ''}</div>
                        <div><strong>Staff Members:</strong> ${staffRows.length}</div>
                    </div>
                `;

                summary.innerHTML = summaryHTML;
            }
        }

        function closeWindow() {
            if (window.opener && !window.opener.closed) {
                window.close();
            } else {
                window.location.href = '../HTML/Partner_Panel.html';
            }
        }

        // =================== DATABASE FUNCTIONS ===================
        async function submitProposalToDatabase() {
            console.log('Starting proposal submission to database...');

            // Show loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                const form = document.getElementById('proposal-form');

                // Collect form data
                const proposalData = {
                    // Basic proposal information
                    subject: document.getElementById('projectTitle').value,
                    organization_name: document.getElementById('organizationName').value,

                    // Project details from Step 1
                    project_type: document.getElementById('projectType').value,
                    beneficiaries_no: parseInt(document.getElementById('beneficiariesNo').value) || 0,
                    beneficiaries_type: document.getElementById('beneficiariesType').value,
                    location: document.getElementById('location').value,
                    start_date: document.getElementById('startDate').value,
                    end_date: document.getElementById('endDate').value,
                    budget_req: parseFloat(document.getElementById('budgetReq').value) || 0,

                    // Rationale from Step 2
                    rationale: document.getElementById('rationaleField').value,

                    // Staffing information
                    staff: collectStaffData(),

                    // Logical Framework from Step 3
                    goal_narrative: document.getElementById('goalNarrative').value,
                    goal_indicators: document.getElementById('goalIndicators').value,
                    goal_movs: document.getElementById('goalMovs').value,
                    purpose_narrative: document.getElementById('purposeNarrative').value,
                    purpose_indicators: document.getElementById('purposeIndicators').value,
                    purpose_movs: document.getElementById('purposeMovs').value,
                    outputs: collectOutputsData(),

                    // Attachments status
                    attachments_gantt: document.getElementById('attachments_gantt').checked,
                    attachments_budget: document.getElementById('attachments_budget').checked,
                    attachments_monitoring: document.getElementById('attachments_monitoring').checked,

                    // Status
                    status: 'submitted',
                    created_at: new Date().toISOString()
                };

                console.log('Proposal data prepared:', proposalData);

                // ====================================================
                // ALTERNATIVE METHOD: Use Supabase's service role key
                // OR temporarily disable RLS for this table
                // ====================================================

                // First, let's check if we can insert using the current client
                // If not, we need to either:
                // 1. Create an RLS policy (recommended)
                // 2. Use service role key (not recommended for frontend)
                // 3. Temporarily disable RLS on the table

                // For now, let's try a direct insert and handle the error
                const { data, error } = await supabase
                    .from('partners_proposals')
                    .insert([{
                        subject: proposalData.subject,
                        organization_name: proposalData.organization_name,
                        collaboration_areas: proposalData.project_type,
                        partnership_outcomes: proposalData.rationale.substring(0, 500),
                        additional_info: JSON.stringify({
                            project_type: proposalData.project_type,
                            beneficiaries_no: proposalData.beneficiaries_no,
                            beneficiaries_type: proposalData.beneficiaries_type,
                            location: proposalData.location,
                            start_date: proposalData.start_date,
                            end_date: proposalData.end_date,
                            budget_req: proposalData.budget_req,
                            goal_narrative: proposalData.goal_narrative,
                            goal_indicators: proposalData.goal_indicators,
                            goal_movs: proposalData.goal_movs,
                            purpose_narrative: proposalData.purpose_narrative,
                            purpose_indicators: proposalData.purpose_indicators,
                            purpose_movs: proposalData.purpose_movs,
                            outputs: proposalData.outputs,
                            staff: proposalData.staff,
                            attachments_status: {
                                gantt: proposalData.attachments_gantt,
                                budget: proposalData.attachments_budget,
                                monitoring: proposalData.attachments_monitoring
                            }
                        }),
                        contact_full_name: partnerData.contact_full_name || '',
                        contact_position: partnerData.contact_position || '',
                        contact_email: partnerData.contact_email || '',
                        contact_phone: partnerData.contact_phone || '',
                        status: 'submitted'
                    }])
                    .select();

                if (error) {
                    console.error('Error inserting proposal:', error);

                    // If it's an RLS error, we need to create a policy
                    if (error.message.includes('row-level security policy')) {
                        throw new Error(
                            'Database security policy is preventing submission. ' +
                            'Please contact the administrator to create an RLS policy ' +
                            'that allows inserts into the partners_proposals table.'
                        );
                    }
                    throw error;
                }

                console.log('Proposal inserted successfully:', data);

                // If there are files to upload, handle them
                if (window.files && window.files.length > 0) {
                    console.log('Uploading files...');
                    await uploadFiles(data[0].id);
                }

                // Show success message
                document.getElementById('successMessage').classList.remove('hidden');
                document.getElementById('proposal-form').classList.add('hidden');

                // Hide error message if it was showing
                document.getElementById('errorMessage').classList.add('hidden');

                // Redirect after 3 seconds
                setTimeout(() => {
                    closeWindow();
                }, 3000);

                return data;

            } catch (error) {
                console.error('Failed to submit proposal:', error);

                // Show error message
                document.getElementById('errorText').textContent =
                    `${error.message || 'Failed to submit proposal. Please try again.'}`;
                document.getElementById('errorMessage').classList.remove('hidden');

                throw error;
            } finally {
                // Hide loading overlay
                loadingOverlay.style.display = 'none';
            }
        }

        function collectStaffData() {
            const staffRows = document.querySelectorAll('#staff-table tbody tr');
            const staff = [];

            staffRows.forEach(row => {
                staff.push({
                    name_role: row.querySelector('[name="staff_name[]"]').value,
                    responsibilities: row.querySelector('[name="staff_responsibilities[]"]').value,
                    contact_person: row.querySelector('[name="staff_contact_person[]"]').value,
                    contact_no: row.querySelector('[name="staff_contact_no[]"]').value
                });
            });

            return staff;
        }

        function collectOutputsData() {
            const outputRows = document.querySelectorAll('.output-row');
            const outputs = [];

            outputRows.forEach(row => {
                outputs.push({
                    narrative: row.querySelector('[name="output_narrative[]"]').value,
                    indicators: row.querySelector('[name="output_indicators[]"]').value,
                    movs: row.querySelector('[name="output_movs[]"]').value
                });
            });

            return outputs;
        }

        async function uploadFiles(proposalId) {
            try {
                for (let i = 0; i < window.files.length; i++) {
                    const file = window.files[i];
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${proposalId}_${Date.now()}_${i}.${fileExt}`;
                    const filePath = `proposal_attachments/${fileName}`;

                    const { error: uploadError } = await supabase.storage
                        .from('proposals')
                        .upload(filePath, file);

                    if (uploadError) {
                        console.error('Error uploading file:', uploadError);
                        // Continue with other files even if one fails
                        continue;
                    }

                    console.log(`File ${fileName} uploaded successfully`);
                }
            } catch (error) {
                console.error('Error in file upload process:', error);
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing form...');

            // Get URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const requestId = urlParams.get('requestId');
            const projectId = urlParams.get('projectId');
            const dataParam = urlParams.get('data');

            // Set hidden fields
            document.getElementById('requestId').value = requestId || '';
            document.getElementById('projectId').value = projectId || '';

            // Load request details if available
            if (requestId) {
                document.getElementById('requestInfo').innerHTML =
                    `Submitting proposal for request: <strong>PR-${requestId.toString().padStart(4, '0')}</strong>`;
            }

            // Load partner data from URL if available
            if (dataParam) {
                try {
                    partnerData = JSON.parse(decodeURIComponent(dataParam));
                    console.log('Partner data loaded:', partnerData);

                    // Pre-fill visible fields
                    if (partnerData.request_subject) {
                        document.getElementById('projectTitle').value =
                            `Project Proposal: ${partnerData.request_subject}`;
                    }

                    if (partnerData.organization_name) {
                        document.getElementById('organizationName').value = partnerData.organization_name;
                    }

                    // Pre-fill rationale with partner data
                    let rationaleText = `Based on partnership request: ${partnerData.request_subject || ''}\n\n`;
                    if (partnerData.request_description) rationaleText += `Request Description: ${partnerData.request_description}\n\n`;
                    if (partnerData.collaboration_areas) rationaleText += `Collaboration Areas: ${partnerData.collaboration_areas}\n\n`;
                    if (partnerData.partnership_outcomes) rationaleText += `Expected Outcomes: ${partnerData.partnership_outcomes}\n`;

                    document.getElementById('rationaleField').value = rationaleText;

                } catch (error) {
                    console.error('Failed to parse partner data from URL:', error);
                }
            }

            // Add default staff row
            function addStaffRow() {
                const staffTbody = document.querySelector('#staff-table .staff-body');
                if (!staffTbody) return;

                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="px-4 py-2">
                        <input type="text" name="staff_name[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-cnsc-violet focus:border-cnsc-violet" required>
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" name="staff_responsibilities[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-cnsc-violet focus:border-cnsc-violet" required>
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" name="staff_contact_person[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-cnsc-violet focus:border-cnsc-violet">
                    </td>
                    <td class="px-4 py-2">
                        <input type="text" name="staff_contact_no[]" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-cnsc-violet focus:border-cnsc-violet">
                    </td>
                `;
                staffTbody.appendChild(newRow);
            }

            // Add default output row
            function addOutputRow() {
                const outputsContainer = document.getElementById('logframe-outputs-container');
                const outputTemplate = document.getElementById('output-row-template');

                if (!outputsContainer || !outputTemplate) return;

                const newRow = outputTemplate.content.cloneNode(true);
                outputsContainer.appendChild(newRow);
            }

            // Add staff row button
            document.getElementById('add-staff-btn').addEventListener('click', addStaffRow);

            // Add output row button
            document.getElementById('add-output-btn').addEventListener('click', addOutputRow);

            // Remove output row handler
            document.getElementById('logframe-outputs-container').addEventListener('click', (e) => {
                if (e.target.closest('.remove-output-btn')) {
                    e.target.closest('.output-row').remove();
                }
            });

            // Add default rows
            addStaffRow();
            addOutputRow();

            // Initialize form steps
            updateFormStep();

            // Next button handler
            document.getElementById('next-btn').addEventListener('click', function() {
                console.log('Next button clicked, current step:', currentStep);
                if (validateStep(currentStep)) {
                    if (currentStep < totalSteps) {
                        if (currentStep === totalSteps - 1) {
                            generateProposalSummary();
                        }
                        currentStep++;
                        updateFormStep();
                    }
                } else {
                    console.log('Validation failed for step', currentStep);
                }
            });

            // Previous button handler
            document.getElementById('prev-btn').addEventListener('click', function() {
                console.log('Previous button clicked, current step:', currentStep);
                if (currentStep > 1) {
                    currentStep--;
                    updateFormStep();
                }
            });

            // Form submission handler
            document.getElementById('proposal-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                console.log('Form submission started');

                // Validate all steps before submission
                let allValid = true;
                for (let step = 1; step <= 4; step++) {
                    if (!validateStep(step)) {
                        allValid = false;
                        // If this step is not valid, go to that step
                        currentStep = step;
                        updateFormStep();
                        break;
                    }
                }

                if (!allValid) {
                    console.log('Form validation failed, stopping submission');
                    return;
                }

                console.log('All form validation passed, submitting to database...');

                try {
                    await submitProposalToDatabase();
                } catch (error) {
                    console.error('Submission failed:', error);
                }
            });

            // File upload setup
            function setupFileUpload() {
                const fileInput = document.getElementById('file-upload');
                const fileList = document.getElementById('file-list');
                const fileDropZone = document.getElementById('fileDropZone');

                if (!fileDropZone || !fileList) return;

                fileDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileDropZone.style.borderColor = '#5A2C9D';
                    fileDropZone.style.backgroundColor = '#f8f5ff';
                });

                fileDropZone.addEventListener('dragleave', () => {
                    fileDropZone.style.borderColor = '#dee2e6';
                    fileDropZone.style.backgroundColor = 'white';
                });

                fileDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileDropZone.style.borderColor = '#dee2e6';
                    fileDropZone.style.backgroundColor = 'white';
                    handleFiles(e.dataTransfer.files);
                });

                if (fileInput) {
                    fileInput.addEventListener('change', (e) => {
                        handleFiles(e.target.files);
                    });
                }

                function handleFiles(newFiles) {
                    for (let file of newFiles) {
                        if (file.size > 10 * 1024 * 1024) {
                            alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                            continue;
                        }
                        window.files.push(file);
                    }
                    updateFileList();
                }

                function updateFileList() {
                    fileList.innerHTML = '';
                    if (window.files.length === 0) {
                        fileList.innerHTML = '<p class="text-gray-500">No files selected</p>';
                        return;
                    }

                    const fileListHTML = window.files.map((file, index) => `
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded mb-1">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <span class="text-sm">${file.name}</span>
                                <span class="text-xs text-gray-500 ml-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
                            </div>
                            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeFile(${index})">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    `).join('');

                    fileList.innerHTML = `<p class="font-medium mb-2">Selected files (${window.files.length}):</p>` + fileListHTML;
                }

                window.removeFile = function(index) {
                    window.files.splice(index, 1);
                    updateFileList();
                };
            }

            setupFileUpload();

            console.log('Form initialization complete');
        });
    </script>
    <div style="display: none;">
    </div>
</body>
</html>